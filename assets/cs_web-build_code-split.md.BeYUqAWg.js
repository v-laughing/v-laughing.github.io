import{_ as i,c as a,o as n,a4 as l}from"./chunks/framework.DdddRsJj.js";const E=JSON.parse('{"title":"代码分割","description":"","frontmatter":{"title":"代码分割"},"headers":[],"relativePath":"cs/web-build/code-split.md","filePath":"cs/web-build/code-split.md"}'),t={name:"cs/web-build/code-split.md"};function p(h,s,e,k,d,r){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="代码分割-code-splitting" tabindex="-1">代码分割 (Code Splitting) <a class="header-anchor" href="#代码分割-code-splitting" aria-label="Permalink to &quot;代码分割 (Code Splitting)&quot;">​</a></h1><p><strong>名词解释</strong>：</p><ul><li><code>bundle</code>: 整体的打包产物，包含 JS 和各种静态资源。</li><li><code>chunk</code>: 打包后的 JS 文件，是 bundle 的子集。</li><li><code>vendor</code>: 第三方包的打包产物，是一种特殊的 chunk。</li></ul><h2 id="为什么需要代码分割" tabindex="-1">为什么需要代码分割？ <a class="header-anchor" href="#为什么需要代码分割" aria-label="Permalink to &quot;为什么需要代码分割？&quot;">​</a></h2><p>如果不进行代码分割，所有代码（业务逻辑 + 第三方库）都会被打包进一个巨大的 <code>index.js</code> 文件中。这会导致：</p><ol><li><strong>首屏加载慢</strong>：用户需要下载完整个 <code>js</code> 文件才能看到页面。</li><li><strong>缓存利用率低</strong>：修改任意一行业务代码，整个大文件都需要重新下载。</li></ol><blockquote><p>一般而言，对于线上站点，服务端在响应资源时，会加上 <code>cache-control</code> 响应头，以指定浏览器的<strong>强缓存</strong>。比如 <code>cache-control: max-age=31536000</code>，表示资源过期时间为一年。在过期之前，访问相同的资源 URL，浏览器直接利用本地的缓存，并不用给服务端发请求。</p></blockquote><h2 id="vite-分包策略" tabindex="-1">Vite 分包策略 <a class="header-anchor" href="#vite-分包策略" aria-label="Permalink to &quot;Vite 分包策略&quot;">​</a></h2><h3 id="默认分包策略" tabindex="-1">默认分包策略 <a class="header-anchor" href="#默认分包策略" aria-label="Permalink to &quot;默认分包策略&quot;">​</a></h3><ul><li><strong>CSS 代码分割</strong>：自动提取 CSS 到单独的文件，即一个 <code>chunk</code> 会有一个 <code>*.css</code> 文件。</li><li><strong>动态导入</strong>：使用 <code>import()</code> 动态导入的模块会自动拆分为独立的 <code>chunk</code>。</li><li><strong>第三方库</strong>：在 Rollup 默认配置下，可能会将所有 vendor 依赖打包在一起。</li></ul><h3 id="自定义拆包-manualchunks" tabindex="-1">自定义拆包 (manualChunks) <a class="header-anchor" href="#自定义拆包-manualchunks" aria-label="Permalink to &quot;自定义拆包 (manualChunks)&quot;">​</a></h3><p>可以通过 <code>build.rollupOptions.output.manualChunks</code> 来自定义拆包策略。</p><h4 id="_1-对象配置-简单" tabindex="-1">1. 对象配置（简单） <a class="header-anchor" href="#_1-对象配置-简单" aria-label="Permalink to &quot;1. 对象配置（简单）&quot;">​</a></h4><p>将体积较大的第三方库（如 React、Vue、Lodash）单独拆分为一个 chunk。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  build: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rollupOptions: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      output: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        manualChunks: {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 将 React 相关库打包成一个 react-vendor.js</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &#39;react-vendor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;react&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;react-dom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 将 Lodash 打包成 lodash.js</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &#39;lodash&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lodash-es&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h4 id="_2-函数配置-灵活" tabindex="-1">2. 函数配置（灵活） <a class="header-anchor" href="#_2-函数配置-灵活" aria-label="Permalink to &quot;2. 函数配置（灵活）&quot;">​</a></h4><p>如果依赖项非常多，手动列出所有包名很麻烦。可以使用函数形式来自动拆分。</p><p><strong>示例：将 node_modules 中的每个包单独打包</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  build: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rollupOptions: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      output: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        manualChunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // id 是文件的绝对路径</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node_modules&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 获取包名，例如 node_modules/react/... -&gt; react</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 注意处理 .pnpm 目录结构（如果使用了 pnpm）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vendor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简单地将所有 node_modules 打包到 vendor 中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h3 id="解决循环引用问题" tabindex="-1">解决循环引用问题 <a class="header-anchor" href="#解决循环引用问题" aria-label="Permalink to &quot;解决循环引用问题&quot;">​</a></h3><p>在进行手动拆包（尤其是使用简单的路径匹配）时，有时会遇到 <strong>Circular Dependency</strong>（循环引用）警告。</p><p>这通常是因为简单的拆包逻辑（例如仅根据模块 ID 路径判断）忽略了模块间的<strong>间接依赖</strong>关系。例如，<code>object-assign</code> 可能是 <code>react</code> 的一个间接依赖，如果我们将 <code>react</code> 打包到 <code>react-vendor</code>，但 <code>object-assign</code> 留在了主包或其他 chunk 中，就可能形成循环引用。</p><p>可以手动实现 <code>manualChunks</code> 函数，核心思路是确保<strong>如果一个模块属于某个特定 chunk 的依赖，那么它也应该被打包进这个 chunk</strong>。</p><p>但这比较繁琐，可以使用社区插件 <code>vite-plugin-chunk-split</code> 来开箱即用地解决这个问题。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vite-plugin-chunk-split</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span></span></code></pre></div><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { chunkSplitPlugin } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite-plugin-chunk-split&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    chunkSplitPlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 指定拆包策略</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      customSplitting: {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. 支持填包名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // \`react\` 和 \`react-dom\` 及其依赖会被自动打包到 \`react-vendor\` chunk 中</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;react-vendor&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;react&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;react-dom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2. 支持正则表达式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // src 中 components 和 utils 下的所有文件打包为 \`components-util\`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;components-util&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">src</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">components</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">src</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">utils</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div>`,26)])])}const c=i(t,[["render",p]]);export{E as __pageData,c as default};
