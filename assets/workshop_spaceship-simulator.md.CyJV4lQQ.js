import{t as De,u as ve,G as q,v as $,l as H,w as pe,m as be,j as ge,V as g,g as P,x as Te,Q as ee,y as _e,p as _,z as ot,f as me,D as Ae,e as le,E as nt,I as Se,J as at,q as he,O as qe,K as st,N as it,U as Oe,F as ke,H as rt,X as lt,Y as ct,B as Ee,i as dt,k as ut,n as Ue,a as mt,Z as pt,s as He,L as ht,r as Xe,_ as Ke,$ as ft,c as wt,d as vt,W as gt,A as yt,o as xt}from"./chunks/three.module.BuDCKSer.js";import{am as Me,p as xe,c as se,o as ne,j as p,a as Q,e as de,t as ce,N as bt,b as Mt,w as Ye,T as St,_ as kt,v as Pt,Y as Dt,a4 as Be,G as Re,k as ue,C as Ct}from"./chunks/framework.DQgBWl2g.js";const At=2e-6,$e=933e-6,Rt=[{name:"太阳",nameEn:"Sun",color:16755251,emissive:16755251,size:2e3,mass:472e11,orbitRadius:0,orbitSpeed:0,rotationSpeed:5e-5,isStar:!0,description:"星系中心，直径4000米"},{name:"余烬孪星",nameEn:"Ember Twin",color:12868666,emissive:10767402,size:171,mass:115e9,orbitRadius:5e3,orbitSpeed:933e-6,rotationSpeed:833e-6,isTwin:!0,twinSide:1,description:"沙漏双星之一，直径342米，公转速度~280m/s，自转周期~126秒"},{name:"灰烬孪星",nameEn:"Ash Twin",color:15259043,emissive:13153667,size:168,mass:106e9,orbitRadius:5e3,orbitSpeed:933e-6,rotationSpeed:.00116,isTwin:!0,twinSide:-1,description:"沙漏双星之一，直径336米，公转速度~280m/s，自转周期~90秒"},{name:"木炉星",nameEn:"Timber Hearth",color:9089674,emissive:6982250,size:250,mass:361e9,orbitRadius:8593,orbitSpeed:419e-6,rotationSpeed:167e-6,description:"地表半径250米，大气175米，公转速度~216m/s，自转周期~628秒",hasAtmosphere:!0,atmosphereColor:8965375,atmosphereThickness:175},{name:"废墟月亮",nameEn:"Attlerock",color:8947848,emissive:4473924,size:75,mass:1e9,moonOf:"木炉星",moonOrbitRadius:600,moonOrbitSpeed:.002,rotationSpeed:.001,description:"木炉星的卫星，无大气"},{name:"脆壳星",nameEn:"Brittle Hollow",color:8035274,emissive:5929898,size:300,mass:334e9,orbitRadius:11691,orbitSpeed:264e-6,rotationSpeed:333e-6,description:"地表半径300米，大气50米，公转速度~185m/s，自转周期~314秒",hasBlackHole:!0,blackHoleSize:53},{name:"深巨星",nameEn:"Giant's Deep",color:5085818,emissive:4033130,size:500,mass:289e10,orbitRadius:16458,orbitSpeed:158e-6,rotationSpeed:1e-5,description:"地表半径500米，大气450米，公转速度~156m/s，表面重力2g，潮汐锁定",hasAtmosphere:!0,atmosphereColor:6728328,atmosphereThickness:450,surfaceGravity:2},{name:"黑棘星",nameEn:"Dark Bramble",color:3824202,emissive:2771514,size:750,mass:99e10,orbitRadius:2e4,orbitSpeed:118e-6,rotationSpeed:2e-4,description:"地表半径750米，大气250米，公转速度~141m/s",hasAtmosphere:!0,atmosphereColor:13421772,atmosphereThickness:250},{name:"闯入者",nameEn:"The Interloper",color:8969710,emissive:6732748,size:77.5,mass:1e10,orbitA:18e3,orbitB:8e3,orbitSpeed:32e-5,rotationSpeed:3e-4,isComet:!0,description:"椭圆轨道彗星，直径155米，公转速度50~450m/s"},{name:"量子卫星",nameEn:"Quantum Moon",color:12237546,emissive:10132170,size:120,mass:1e10,moonOrbitRadius:1200,moonOrbitSpeed:8e-4,rotationSpeed:.0015,isQuantum:!0,description:"地表半径120米，浓厚银灰色云雾130米"}],Ne=["灰烬孪星","脆壳星","深巨星","黑棘星","木炉星"];class Pe{constructor(e=Math.random()){this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(let a=0;a<256;a++)this.p[a]=a;let o,n;for(let a=255;a>0;a--)e=e*16807%2147483647,o=e%(a+1),n=this.p[a],this.p[a]=this.p[o],this.p[o]=n;for(let a=0;a<512;a++)this.perm[a]=this.p[a&255],this.permMod12[a]=this.perm[a]%12;this.grad3=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),this.F2=.5*(Math.sqrt(3)-1),this.G2=(3-Math.sqrt(3))/6,this.F3=1/3,this.G3=1/6}noise2D(e,o){const{perm:n,permMod12:a,grad3:r,F2:l,G2:s}=this,i=(e+o)*l,c=Math.floor(e+i),u=Math.floor(o+i),y=(c+u)*s,M=c-y,C=u-y,h=e-M,w=o-C;let d,f;h>w?(d=1,f=0):(d=0,f=1);const b=h-d+s,v=w-f+s,m=h-1+2*s,S=w-1+2*s,x=c&255,D=u&255;let k=0,L=0,I=0,V=.5-h*h-w*w;if(V>=0){const A=a[x+n[D]]*3;V*=V,k=V*V*(r[A]*h+r[A+1]*w)}let R=.5-b*b-v*v;if(R>=0){const A=a[x+d+n[D+f]]*3;R*=R,L=R*R*(r[A]*b+r[A+1]*v)}let z=.5-m*m-S*S;if(z>=0){const A=a[x+1+n[D+1]]*3;z*=z,I=z*z*(r[A]*m+r[A+1]*S)}return 70*(k+L+I)}noise3D(e,o,n){const{perm:a,permMod12:r,grad3:l,F3:s,G3:i}=this,c=(e+o+n)*s,u=Math.floor(e+c),y=Math.floor(o+c),M=Math.floor(n+c),C=(u+y+M)*i,h=u-C,w=y-C,d=M-C,f=e-h,b=o-w,v=n-d;let m,S,x,D,k,L;f>=b?b>=v?(m=1,S=0,x=0,D=1,k=1,L=0):f>=v?(m=1,S=0,x=0,D=1,k=0,L=1):(m=0,S=0,x=1,D=1,k=0,L=1):b<v?(m=0,S=0,x=1,D=0,k=1,L=1):f<v?(m=0,S=1,x=0,D=0,k=1,L=1):(m=0,S=1,x=0,D=1,k=1,L=0);const I=f-m+i,V=b-S+i,R=v-x+i,z=f-D+2*i,A=b-k+2*i,E=v-L+2*i,N=f-1+3*i,B=b-1+3*i,W=v-1+3*i,X=u&255,T=y&255,O=M&255;let K=0,Y=0,Z=0,J=0,te=.6-f*f-b*b-v*v;if(te>=0){const G=r[X+a[T+a[O]]]*3;te*=te,K=te*te*(l[G]*f+l[G+1]*b+l[G+2]*v)}let ie=.6-I*I-V*V-R*R;if(ie>=0){const G=r[X+m+a[T+S+a[O+x]]]*3;ie*=ie,Y=ie*ie*(l[G]*I+l[G+1]*V+l[G+2]*R)}let re=.6-z*z-A*A-E*E;if(re>=0){const G=r[X+D+a[T+k+a[O+L]]]*3;re*=re,Z=re*re*(l[G]*z+l[G+1]*A+l[G+2]*E)}let oe=.6-N*N-B*B-W*W;if(oe>=0){const G=r[X+1+a[T+1+a[O+1]]]*3;oe*=oe,J=oe*oe*(l[G]*N+l[G+1]*B+l[G+2]*W)}return 32*(K+Y+Z+J)}}const fe=(t,e,o,n,a=4,r=2,l=.5)=>{let s=0,i=1,c=1,u=0;for(let y=0;y<a;y++)s+=t.noise3D(e*c,o*c,n*c)*i,u+=i,i*=l,c*=r;return s/u},Ze={余烬孪星:{seed:23456,resolution:512,baseColors:[{color:[196,92,58],weight:.5},{color:[180,70,40],weight:.3},{color:[220,120,60],weight:.2}],noiseScale:4,octaves:4,bumpStrength:1.5,hasLava:!0,lavaColor:[255,100,20]},灰烬孪星:{seed:34567,resolution:512,baseColors:[{color:[232,213,163],weight:.4},{color:[200,180,140],weight:.35},{color:[180,160,120],weight:.25}],noiseScale:5,octaves:4,bumpStrength:.8},脆壳星:{seed:45678,resolution:512,baseColors:[{color:[122,155,202],weight:.4},{color:[90,120,170],weight:.3},{color:[60,80,120],weight:.2},{color:[40,50,80],weight:.1}],noiseScale:4,octaves:5,bumpStrength:1.8,hasCracks:!0,crackColor:[20,10,40]},深巨星:{seed:56789,resolution:512,baseColors:[{color:[77,154,122],weight:.5},{color:[60,130,100],weight:.3},{color:[100,180,140],weight:.2}],noiseScale:2,octaves:6,bumpStrength:.4,isGasGiant:!0,bandColors:[[60,140,100],[80,160,120],[50,120,90]]},黑棘星:{seed:67890,resolution:512,baseColors:[{color:[58,90,74],weight:.5},{color:[40,70,55],weight:.3},{color:[30,50,40],weight:.2}],noiseScale:3,octaves:5,bumpStrength:2,hasBrambles:!0},量子卫星:{seed:78901,resolution:256,baseColors:[{color:[186,186,234],weight:.5},{color:[160,160,210],weight:.3},{color:[140,140,190],weight:.2}],noiseScale:4,octaves:3,bumpStrength:.6,isQuantum:!0},闯入者:{seed:89012,resolution:256,baseColors:[{color:[136,221,238],weight:.6},{color:[180,240,250],weight:.3},{color:[100,200,220],weight:.1}],noiseScale:6,octaves:3,bumpStrength:.5,isIcy:!0},废墟月亮:{seed:90123,resolution:256,baseColors:[{color:[136,136,136],weight:.5},{color:[100,100,100],weight:.3},{color:[80,80,80],weight:.2}],noiseScale:5,octaves:4,bumpStrength:1,hasCraters:!0}},zt=t=>{if(!t||!t.baseColors||t.baseColors.length===0)return null;const{seed:e,resolution:o,baseColors:n,noiseScale:a,octaves:r,hasOcean:l,oceanLevel:s,oceanColor:i,isGasGiant:c,bandColors:u,hasCracks:y,crackColor:M,hasLava:C,lavaColor:h}=t,w=document.createElement("canvas");w.width=o,w.height=o;const d=w.getContext("2d"),f=d.createImageData(o,o),b=f.data,v=new Pe(e),m=new Pe(e+1e3);for(let x=0;x<o;x++)for(let D=0;D<o;D++){const k=D/o,L=x/o,I=k*Math.PI*2,V=L*Math.PI,R=Math.sin(V)*Math.cos(I),z=Math.sin(V)*Math.sin(I),A=Math.cos(V);let E=fe(v,R*a,z*a,A*a,r);E=(E+1)*.5;let N,B,W;if(c&&u&&u.length>0){const T=fe(m,R*1.5,z*1.5,A*.5,3)*.3,O=(L+T)*u.length*3%u.length,K=Math.floor(O<0?O+u.length:O),Y=u[Math.min(K,u.length-1)],Z=E*.3;N=Math.min(255,Y[0]+Z*50),B=Math.min(255,Y[1]+Z*50),W=Math.min(255,Y[2]+Z*30)}else if(l&&i&&E<s){const T=(s-E)/s;N=i[0]*(1-T*.3),B=i[1]*(1-T*.2),W=i[2]*(1+T*.2)}else{let T=0;N=B=W=0,n.forEach((K,Y)=>{const Z=fe(m,R*(a+Y),z*(a+Y),A*(a+Y),3),J=K.weight*(.5+Z*.5);N+=K.color[0]*J,B+=K.color[1]*J,W+=K.color[2]*J,T+=J}),N/=T,B/=T,W/=T;const O=(E-.5)*40;N=Math.max(0,Math.min(255,N+O)),B=Math.max(0,Math.min(255,B+O)),W=Math.max(0,Math.min(255,W+O))}if(y&&M){const T=fe(m,R*8,z*8,A*8,2);if(Math.abs(T)<.08){const O=1-Math.abs(T)/.08;N=N*(1-O)+M[0]*O,B=B*(1-O)+M[1]*O,W=W*(1-O)+M[2]*O}}if(C&&h){const T=fe(m,R*6,z*6,A*6,3);if(T>.5){const O=(T-.5)*2;N=N*(1-O)+h[0]*O,B=B*(1-O)+h[1]*O,W=W*(1-O)+h[2]*O}}const X=(x*o+D)*4;b[X]=N,b[X+1]=B,b[X+2]=W,b[X+3]=255}d.putImageData(f,0,0);const S=new De(w);return S.wrapS=ve,S.wrapT=ve,S},Vt=t=>{if(!t)return null;const{seed:e,resolution:o,noiseScale:n,octaves:a,bumpStrength:r,hasCraters:l}=t,s=document.createElement("canvas");s.width=o,s.height=o;const i=s.getContext("2d"),c=i.createImageData(o,o),u=c.data,y=new Pe(e),M=new Pe(e+500),C=new Float32Array(o*o);for(let d=0;d<o;d++)for(let f=0;f<o;f++){const b=f/o,v=d/o,m=b*Math.PI*2,S=v*Math.PI,x=Math.sin(S)*Math.cos(m),D=Math.sin(S)*Math.sin(m),k=Math.cos(S);let L=fe(y,x*n,D*n,k*n,a);if(l)for(let I=0;I<5;I++){const V=M.noise2D(I*10,0)*.5+.5,R=M.noise2D(0,I*10)*.5+.5,z=.05+M.noise2D(I,I)*.03,A=b-V,E=v-R,N=Math.sqrt(A*A+E*E);if(N<z){const B=(1-N/z)*.5;L-=B*(1-Math.pow(N/z,2))}}C[d*o+f]=L}const h=r*2;for(let d=0;d<o;d++)for(let f=0;f<o;f++){const b=(f-1+o)%o,v=(f+1)%o,m=(d-1+o)%o,S=(d+1)%o,x=C[d*o+b],D=C[d*o+v],k=C[m*o+f],L=C[S*o+f],I=(D-x)*h,V=(L-k)*h;let R=-I,z=-V,A=1;const E=Math.sqrt(R*R+z*z+A*A);R/=E,z/=E,A/=E;const N=(d*o+f)*4;u[N]=Math.floor((R*.5+.5)*255),u[N+1]=Math.floor((z*.5+.5)*255),u[N+2]=Math.floor((A*.5+.5)*255),u[N+3]=255}i.putImageData(c,0,0);const w=new De(s);return w.wrapS=ve,w.wrapT=ve,w},Gt=t=>{const{seed:e,resolution:o,noiseScale:n,hasOcean:a,oceanLevel:r}=t,l=document.createElement("canvas");l.width=o,l.height=o;const s=l.getContext("2d"),i=s.createImageData(o,o),c=i.data,u=new Pe(e+2e3);for(let M=0;M<o;M++)for(let C=0;C<o;C++){const h=C/o,w=M/o,d=h*Math.PI*2,f=w*Math.PI,b=Math.sin(f)*Math.cos(d),v=Math.sin(f)*Math.sin(d),m=Math.cos(f);let S=fe(u,b*n,v*n,m*n,4);S=(S+1)*.5;let x;a&&S<(r||.35)?x=.1+Math.random()*.1:x=.4+S*.4+Math.random()*.1;const D=Math.floor(x*255),k=(M*o+C)*4;c[k]=D,c[k+1]=D,c[k+2]=D,c[k+3]=255}s.putImageData(i,0,0);const y=new De(l);return y.wrapS=ve,y.wrapT=ve,y},Lt=t=>{const e=Ze[t];if(!e||!e.baseColors)return null;const o=zt(e),n=Vt(e),a=Gt(e);return!o||!n?null:{diffuseMap:o,normalMap:n,roughnessMap:a}},Ie={vertexShader:`
    varying vec3 vWorldNormal;
    varying vec3 vWorldPosition;
    
    void main() {
      vWorldNormal = normalize(modelMatrix * vec4(normal, 0.0)).xyz;
      vec4 worldPos = modelMatrix * vec4(position, 1.0);
      vWorldPosition = worldPos.xyz;
      gl_Position = projectionMatrix * viewMatrix * worldPos;
    }
  `,fragmentShader:`
    uniform vec3 glowColor;
    uniform float intensity;
    uniform float power;
    uniform vec3 sunPosition;
    uniform float planetRadius;
    uniform float atmoRadius;
    
    varying vec3 vWorldNormal;
    varying vec3 vWorldPosition;
    
    void main() {
      vec3 viewDir = normalize(cameraPosition - vWorldPosition);
      vec3 sunDir = normalize(sunPosition - vWorldPosition);
      
      // --- 核心逻辑：基于距离的密度衰减 ---
      float dotNV = dot(vWorldNormal, viewDir);
      
      // d 是视线路径距离星球中心的最近距离
      float d = atmoRadius * sqrt(1.0 - dotNV * dotNV);
      
      // 密度函数：在 atmoRadius 到 planetRadius 之间平滑衰减
      float density = smoothstep(atmoRadius, planetRadius, d);
      density = pow(density, power); 

      // --- 太阳遮蔽与散射 ---
      float sunMix = dot(vWorldNormal, sunDir);
      // 模拟大气的光散，向阳面明亮
      // 修改：背光面不再是完全死黑，保留 0.15 的基础亮度模拟弱散射
      float shadowMask = smoothstep(-0.4, 0.5, sunMix);
      shadowMask = mix(0.15, 1.0, shadowMask);
      
      // 靠近地表的额外浓郁感 (Haze)
      float baseHaze = pow(max(0.0, dotNV), 3.0) * 0.5;
      
      vec3 color = glowColor;
      // 向阳面亮度增强，混合高光色
      vec3 sunGlow = vec3(0.2, 0.3, 0.5) * clamp(sunMix, 0.0, 1.0) * density;
      color += sunGlow;

      // 最终强度受 intensity 统一控制
      float finalAlpha = (density + baseHaze) * shadowMask * intensity;
      
      // 彻底消除球体几何边缘的硬切痕
      finalAlpha *= smoothstep(0.0, 0.1, abs(dotNV));

      gl_FragColor = vec4(color, finalAlpha);
    }
  `},Nt=(t,e)=>{const{color:o=8965375,thickness:n=50,intensity:a=1,power:r=2.5}=e,l=new q,s=new $(o),i=t+n,c=new H(i,64,64),u=new pe({vertexShader:Ie.vertexShader,fragmentShader:Ie.fragmentShader,uniforms:{glowColor:{value:s},intensity:{value:a},power:{value:r},sunPosition:{value:new g(0,0,0)},planetRadius:{value:t},atmoRadius:{value:i}},transparent:!0,blending:ge,side:be,depthWrite:!1}),y=new P(c,u);y.userData.isAtmosphereLayer=!0,l.add(y);const M=It(t,s,a);return l.add(M),l},It=(t,e,o)=>{const n=new H(t+.5,64,64),a=new pe({vertexShader:Ie.vertexShader,fragmentShader:`
      uniform vec3 glowColor;
      uniform float intensity;
      uniform vec3 sunPosition;
      
      varying vec3 vWorldNormal;
      varying vec3 vWorldPosition;
      
      void main() {
        vec3 viewDir = normalize(cameraPosition - vWorldPosition);
        vec3 sunDir = normalize(sunPosition - vWorldPosition);
        
        float dotNV = max(0.0, dot(vWorldNormal, viewDir));
        
        // 内部雾气主要负责覆盖在陆地上的那一层薄晕
        float rimIntensity = pow(1.0 - dotNV, 3.0) * 0.6;
        
        float sunMix = dot(vWorldNormal, sunDir);
        // 内部雾气在背光面也保留一点基础可见度
        float shadowMask = smoothstep(-0.3, 0.5, sunMix);
        shadowMask = mix(0.2, 1.0, shadowMask);
        
        vec3 finalColor = glowColor * (1.0 + clamp(sunMix, 0.0, 1.0) * 0.5);
        float alpha = rimIntensity * intensity * shadowMask;
        
        gl_FragColor = vec4(finalColor * alpha, alpha);
      }
    `,uniforms:{glowColor:{value:e},intensity:{value:o},sunPosition:{value:new g(0,0,0)}},transparent:!0,blending:ge,side:Te,depthWrite:!1});return new P(n,a)},Tt=(t,e)=>{t.children.forEach(o=>{o.material&&o.material.uniforms&&o.material.uniforms.sunPosition&&o.material.uniforms.sunPosition.value.copy(e)})},_t={深巨星:{color:4500104,thickness:200,intensity:1.4,power:2},黑棘星:{color:8952200,thickness:80,intensity:.6,power:3.5}},Et=(t,e=6710886)=>{const o=new it(t,0),n=new _({color:e,roughness:.9,metalness:.1});return new P(o,n)},Ft=(t,e,o=4863784,n=2972199)=>{const a=new q,r=new le(t*.1,t*.15,t,6),l=new _({color:o,roughness:.9}),s=new P(r,l);s.position.y=t/2,a.add(s);const i=new st(e,1),c=new _({color:n,roughness:.8}),u=new P(i,c);return u.position.y=t+e*.5,a.add(u),a},Ot=(t,e,o,n=9139029)=>{const a=new q,r=new Se(t,e,o),l=new _({color:n,roughness:.7}),s=new P(r,l);s.position.y=e/2,a.add(s);const i=new he(t*.8,e*.4,4),c=new _({color:5917242,roughness:.8}),u=new P(i,c);return u.position.y=e+e*.2,u.rotation.y=Math.PI/4,a.add(u),a},Bt=(t,e=8943462)=>{const o=new q,n=new Se(t*.3,t*.1,t*.3),a=new _({color:e,roughness:.6}),r=new P(n,a);r.position.y=t*.05,o.add(r);const l=new Se(t*.15,t*.8,t*.15),s=new P(l,a);s.position.y=t*.5,o.add(s);const i=new qe(t*.12,0),c=new _({color:11193599,emissive:4482730,emissiveIntensity:.5,roughness:.3}),u=new P(i,c);return u.position.y=t*.95,o.add(u),o},Wt=(t,e=12888194)=>{const o=new q,n=new le(t*.15,t*.2,t,8),a=new _({color:e,roughness:.7}),r=new P(n,a);r.position.y=t/2,o.add(r);const l=new he(t*.2,t*.3,8),s=new P(l,a);return s.position.y=t+t*.15,o.add(s),o},Qt=(t,e=8969727)=>{const o=new q,n=new qe(t,0),a=new _({color:e,emissive:e,emissiveIntensity:.3,roughness:.2,metalness:.8,transparent:!0,opacity:.8}),r=new P(n,a);return r.scale.y=2,o.add(r),o},jt=(t,e=2771514)=>{const o=new q,n=new he(t*.3,t,5),a=new _({color:e,roughness:.8}),r=new P(n,a);r.position.y=t/2,o.add(r);for(let l=0;l<3;l++){const s=new he(t*.15,t*.5,4),i=new P(s,a);i.position.y=t*.3,i.position.x=Math.cos(l*Math.PI*2/3)*t*.2,i.position.z=Math.sin(l*Math.PI*2/3)*t*.2,i.rotation.z=Math.PI/6*(l%2===0?1:-1),o.add(i)}return o},qt=t=>{const e=new q,o=new H(t,16,16),n=new _({color:11206570,emissive:6750054,emissiveIntensity:.8,roughness:.3}),a=new P(o,n);e.add(a);const r=new H(t*2,16,16),l=new me({color:4521796,transparent:!0,opacity:.2}),s=new P(r,l);return e.add(s),e},Ut=t=>{const e=new q,o=new at(t,0),n=new _({color:13421806,emissive:8947882,emissiveIntensity:.4,roughness:.4,metalness:.6}),a=new P(o,n);return a.rotation.set(Math.random(),Math.random(),Math.random()),e.add(a),e},Ht=(t,e=8943462)=>{const o=new q;for(let l=0;l<4;l++){const s=t*(.5+Math.random()*.5),i=new le(t*.1,t*.12,s,6),c=new _({color:e,roughness:.8}),u=new P(i,c);u.position.x=Math.cos(l*Math.PI/2)*t*.4,u.position.z=Math.sin(l*Math.PI/2)*t*.4,u.position.y=s/2,o.add(u)}const n=new Se(t,t*.1,t),a=new _({color:e,roughness:.8}),r=new P(n,a);return r.position.y=t*.05,o.add(r),o},Xt=t=>{const e=new q,o=new le(t,t,t*.1,16),n=new _({color:5592405,roughness:.5,metalness:.3}),a=new P(o,n);a.position.y=t*.05,e.add(a);const r=new _e(t*.8,t*.05,8,32),l=new _({color:16755200,emissive:16746496,emissiveIntensity:.3}),s=new P(r,l);return s.rotation.x=Math.PI/2,s.position.y=t*.12,e.add(s),e},Kt=t=>{const e=new q,o=new le(t*.3,t*.4,t*.2,8),n=new _({color:4473924,roughness:.5,metalness:.5}),a=new P(o,n);a.position.y=t*.1,e.add(a);const r=new le(t*.1,t*.15,t*.8,8),l=new _({color:6710886,roughness:.4,metalness:.6}),s=new P(r,l);return s.position.y=t*.5,s.rotation.x=Math.PI/6,e.add(s),e},Yt=t=>{const e=new q,o=new le(t*.05,t*.05,t,8),n=new _({color:9127187}),a=new P(o,n);a.position.y=t/2,e.add(a);const r=new nt(t*.4,t*.25),l=new _({color:5085818,side:Ae,emissive:2976330,emissiveIntensity:.2}),s=new P(r,l);return s.position.y=t*.85,s.position.x=t*.2,e.add(s),e},$t=t=>{const e=new q,o=new _e(t,t*.2,8,16),n=new _({color:5592405,roughness:.9}),a=new P(o,n);return a.rotation.x=Math.PI/2,e.add(a),e},Zt=t=>{const e=new q,o=new _e(t,t*.1,8,32),n=new _({color:12888194,roughness:.5,metalness:.3}),a=new P(o,n);a.rotation.x=Math.PI/2,a.position.y=t,e.add(a);const r=new ot(t*.85,32),l=new me({color:4482730,transparent:!0,opacity:.5,side:Ae}),s=new P(r,l);s.rotation.x=Math.PI/2,s.position.y=t,e.add(s);const i=new le(t*.15,t*.2,t*.3,8),c=new P(i,n);return c.position.y=t*.15,e.add(c),e},Je={余烬孪星:{landmarks:[{type:"ruin",count:3,sizeRange:[8,15],color:10518624},{type:"obelisk",count:5,sizeRange:[6,12]},{type:"rock",count:20,sizeRange:[2,6],color:12868666}]},灰烬孪星:{landmarks:[{type:"tower",count:4,sizeRange:[10,20],color:13943970},{type:"portal",count:2,sizeRange:[5,8]},{type:"rock",count:15,sizeRange:[2,5],color:15259043}]},废墟月亮:{landmarks:[{type:"crater",count:5,sizeRange:[3,8]},{type:"ruin",count:2,sizeRange:[5,10],color:6710886},{type:"rock",count:20,sizeRange:[1,4],color:8947848}]},脆壳星:{landmarks:[{type:"tower",count:3,sizeRange:[12,18],color:9087690},{type:"ruin",count:4,sizeRange:[8,14],color:8035274},{type:"crystal",count:8,sizeRange:[3,7],color:6719692},{type:"rock",count:15,sizeRange:[2,5],color:5929898}]},深巨星:{landmarks:[{type:"islandMarker",count:6,sizeRange:[8,12]},{type:"tower",count:2,sizeRange:[15,25],color:6138506},{type:"rock",count:10,sizeRange:[3,8],color:5085818}]},黑棘星:{landmarks:[{type:"thorn",count:30,sizeRange:[8,20]},{type:"glowingSeed",count:15,sizeRange:[1,3]},{type:"rock",count:10,sizeRange:[3,8],color:3824202}]},闯入者:{landmarks:[{type:"crystal",count:12,sizeRange:[2,6],color:11202303},{type:"rock",count:10,sizeRange:[1,4],color:8969710}]},量子卫星:{landmarks:[{type:"quantumShard",count:20,sizeRange:[2,5]},{type:"obelisk",count:3,sizeRange:[5,10]},{type:"rock",count:10,sizeRange:[1,4],color:12237546}]}},Jt={rock:(t,e)=>Et(t,e),tree:t=>Ft(t,t*.6),building:t=>Ot(t,t*1.5,t),obelisk:t=>Bt(t),tower:(t,e)=>Wt(t,e),crystal:(t,e)=>Qt(t,e),thorn:t=>jt(t),glowingSeed:t=>qt(t),quantumShard:t=>Ut(t),ruin:(t,e)=>Ht(t,e),launchPad:t=>Xt(t),telescope:t=>Kt(t),islandMarker:t=>Yt(t),crater:t=>$t(t),portal:t=>Zt(t)},eo=(t,e,o)=>{const n=Je[t];if(!n)return;let a=0;for(let l=0;l<t.length;l++)a+=t.charCodeAt(l);const r=()=>{const l=Math.sin(a++)*1e4;return l-Math.floor(l)};n.landmarks.forEach(l=>{const{type:s,count:i,sizeRange:c,color:u}=l,y=Jt[s];if(y)for(let M=0;M<i;M++){const C=c[0]+r()*(c[1]-c[0]),h=y(C,u),w=r()*Math.PI*2,d=Math.acos(2*r()-1),f=Math.sin(d)*Math.cos(w),b=Math.sin(d)*Math.sin(w),v=Math.cos(d),m=new g(f,b,v).multiplyScalar(e);h.position.copy(m);const S=m.clone().normalize(),x=new g(0,1,0),D=new ee().setFromUnitVectors(x,S);h.quaternion.copy(D),h.rotateY(r()*Math.PI*2),o.add(h)}})},ze={uniforms:{time:{value:0},colorBright:{value:new $(16774579)},colorDark:{value:new $(16729344)},fresnelColor:{value:new $(16763904)}},vertexShader:`
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vViewPosition;

    void main() {
      vUv = uv;
      vNormal = normalize(normalMatrix * normal);
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      vViewPosition = -mvPosition.xyz;
      gl_Position = projectionMatrix * mvPosition;
    }
  `,fragmentShader:`
    uniform float time;
    uniform vec3 colorBright;
    uniform vec3 colorDark;
    uniform vec3 fresnelColor;
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vViewPosition;

    // 经典噪声函数
    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }

    float snoise(vec2 v) {
      const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
      vec2 i  = floor(v + dot(v, C.yy));
      vec2 x0 = v -   i + dot(i, C.xx);
      vec2 i1;
      i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
      vec4 x12 = x0.xyxy + C.xxzz;
      x12.xy -= i1;
      i = mod289(i);
      vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
      vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
      m = m*m; m = m*m;
      vec3 x = 2.0 * fract(p * C.www) - 1.0;
      vec3 h = abs(x) - 0.5;
      vec3 ox = floor(x + 0.5);
      vec3 a0 = x - ox;
      m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
      vec3 g;
      g.x  = a0.x  * x0.x  + h.x  * x0.y;
      g.yz = a0.yz * x12.xz + h.yz * x12.yw;
      return 130.0 * dot(m, g);
    }

    void main() {
      // 多层噪声叠加形成动态表面
      float noise = snoise(vUv * 4.0 + time * 0.05);
      noise += 0.5 * snoise(vUv * 8.0 - time * 0.07);
      noise = noise * 0.5 + 0.5;

      // 混合基础颜色
      vec3 baseColor = mix(colorDark, colorBright, noise);

      // 菲涅尔效果：让球体中心亮，边缘带有强烈的辐射感
      vec3 viewDir = normalize(vViewPosition);
      float fresnel = pow(1.0 - max(0.0, dot(vNormal, viewDir)), 1.5);
      
      // 增加曝光感：在中心区域叠加极高亮度
      float centerBrightness = pow(max(0.0, dot(vNormal, viewDir)), 2.0);
      vec3 finalColor = baseColor * (1.0 + centerBrightness * 0.5) + fresnelColor * fresnel * 2.5;

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},Ve={uniforms:{time:{value:0},glowColor:{value:new $(16746496)}},vertexShader:`
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    varying vec3 vPosition;

    void main() {
      vPosition = position;
      vNormal = normalize(normalMatrix * normal);
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      vViewPosition = -mvPosition.xyz;
      gl_Position = projectionMatrix * mvPosition;
    }
  `,fragmentShader:`
    uniform float time;
    uniform vec3 glowColor;
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    varying vec3 vPosition;

    void main() {
      vec3 viewDir = normalize(vViewPosition);
      
      float vDotN = clamp(abs(dot(vNormal, viewDir)), 0.0, 1.0);
      
      float edgeSoftness = smoothstep(0.0, 0.7, vDotN);
      float rim = 1.0 - vDotN;
      float intensity = pow(rim, 1.35) * pow(edgeSoftness, 2.4);
      
      float pulse = 0.92 + 0.08 * sin(time * 1.7);
      float colorStrength = pow(intensity, 1.05);
      
      gl_FragColor = vec4(glowColor * pulse * 2.2 * colorStrength, intensity);
    }
  `};function to(t){const e=new q,o=new H(t,128,128),n=new pe({uniforms:Oe.clone(ze.uniforms),vertexShader:ze.vertexShader,fragmentShader:ze.fragmentShader}),a=new P(o,n);a.name="SunSurface",e.add(a);const r=new H(t*1.85,64,64),l=new pe({uniforms:Oe.clone(Ve.uniforms),vertexShader:Ve.vertexShader,fragmentShader:Ve.fragmentShader,side:be,blending:ge,transparent:!0,depthWrite:!1}),s=new P(r,l);s.name="SunHalo",e.add(s);const i=new H(t*1.05,64,64),c=new pe({vertexShader:`
      varying vec3 vNormal;
      varying vec3 vViewPosition;
      void main() {
        vNormal = normalize(normalMatrix * normal);
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        vViewPosition = -mvPosition.xyz;
        gl_Position = projectionMatrix * mvPosition;
      }
    `,fragmentShader:`
      uniform vec3 color;
      varying vec3 vNormal;
      varying vec3 vViewPosition;
      void main() {
        vec3 viewDir = normalize(vViewPosition);
        float vDotN = max(0.0, dot(viewDir, vNormal));
        float rim = 1.0 - vDotN;
        float alpha = pow(rim, 5.0) * pow(vDotN, 0.85) * 1.8;
        gl_FragColor = vec4(color * alpha, alpha);
      }
    `,uniforms:{color:{value:new $(16773290)}},transparent:!0,blending:ge,side:Te,depthWrite:!1}),u=new P(i,c);return e.add(u),e}function oo(t,e){t.children.forEach(o=>{o.material&&o.material.uniforms&&o.material.uniforms.time&&(o.material.uniforms.time.value=e),o.name==="SunSurface"&&(o.rotation.y+=1e-4)})}const no=t=>{let e=t>>>0;return()=>(e^=e<<13,e^=e>>>17,e^=e<<5,(e>>>0)/4294967296)};class ao{constructor(e=1){const o=no(e),n=new Uint8Array(256);for(let a=0;a<256;a++)n[a]=a;for(let a=255;a>0;a--){const r=Math.floor(o()*(a+1)),l=n[a];n[a]=n[r],n[r]=l}this.perm=new Uint8Array(512);for(let a=0;a<512;a++)this.perm[a]=n[a&255];this.grad3=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),this.F3=1/3,this.G3=1/6}noise3d(e,o,n){const{perm:a,grad3:r,F3:l,G3:s}=this,i=(e+o+n)*l,c=Math.floor(e+i),u=Math.floor(o+i),y=Math.floor(n+i),M=(c+u+y)*s,C=c-M,h=u-M,w=y-M,d=e-C,f=o-h,b=n-w;let v,m,S,x,D,k;d>=f?f>=b?(v=1,m=0,S=0,x=1,D=1,k=0):d>=b?(v=1,m=0,S=0,x=1,D=0,k=1):(v=0,m=0,S=1,x=1,D=0,k=1):f<b?(v=0,m=0,S=1,x=0,D=1,k=1):d<b?(v=0,m=1,S=0,x=0,D=1,k=1):(v=0,m=1,S=0,x=1,D=1,k=0);const L=d-v+s,I=f-m+s,V=b-S+s,R=d-x+2*s,z=f-D+2*s,A=b-k+2*s,E=d-1+3*s,N=f-1+3*s,B=b-1+3*s,W=c&255,X=u&255,T=y&255,O=a[W+a[X+a[T]]]%12,K=a[W+v+a[X+m+a[T+S]]]%12,Y=a[W+x+a[X+D+a[T+k]]]%12,Z=a[W+1+a[X+1+a[T+1]]]%12;let J=0,te=0,ie=0,re=0,oe=.6-d*d-f*f-b*b;if(oe>0){oe*=oe;const F=O*3;J=oe*oe*(r[F]*d+r[F+1]*f+r[F+2]*b)}let G=.6-L*L-I*I-V*V;if(G>0){G*=G;const F=K*3;te=G*G*(r[F]*L+r[F+1]*I+r[F+2]*V)}let j=.6-R*R-z*z-A*A;if(j>0){j*=j;const F=Y*3;ie=j*j*(r[F]*R+r[F+1]*z+r[F+2]*A)}let ae=.6-E*E-N*N-B*B;if(ae>0){ae*=ae;const F=Z*3;re=ae*ae*(r[F]*E+r[F+1]*N+r[F+2]*B)}return 32*(J+te+ie+re)}}class so extends q{constructor(){super(),this.radius=250,this.waterLevel=246.5,this.maxHeight=8,this.segments=256,this.simplex=new ao(12345),this.colors={water:new $(1722990),grass:new $(3824170),rock:new $(5921360),snow:new $(15658734),crater:new $(2763301),trunk:new $(4008735),leaves:new $(1717018)},this.init()}init(){this.createTerrain(),this.createWater(),this.createAtmosphere(),this.createClouds(),this.createLocalLights()}getNoise(e,o,n=4){let a=0,r=1,l=o;for(let s=0;s<n;s++)a+=this.simplex.noise3d(e.x*l,e.y*l,e.z*l)*r,r*=.5,l*=2;return a}createTerrain(){const e=new H(this.radius,this.segments,this.segments);e.deleteAttribute("uv");const o=e.attributes.position,n=new Float32Array(o.count*3),a=[],r=new g;for(let s=0;s<o.count;s++){r.fromBufferAttribute(o,s);let i=this.getNoise(r,.005,3);const c=this.simplex.noise3d(r.x*.015,r.y*.015,r.z*.015);let u=0;c>.6&&(u=Math.pow((c-.6)*3,2)*-4);const y=i*this.maxHeight+u,M=r.clone().normalize().multiplyScalar(this.radius+y);o.setXYZ(s,M.x,M.y,M.z);let C=this.colors.grass.clone();y>this.maxHeight*.7?C.lerp(this.colors.snow,(y-this.maxHeight*.7)/(this.maxHeight*.3)):y<-1?C.lerp(this.colors.rock,.8):u<-1?C=this.colors.crater.clone():C.multiplyScalar(.8+Math.random()*.4),n[s*3]=C.r,n[s*3+1]=C.g,n[s*3+2]=C.b,y>0&&y<3&&Math.random()>.998&&a.push(M)}e.setAttribute("color",new ke(n,3)),e.computeVertexNormals();const l=new _({vertexColors:!0,roughness:.95,metalness:.05,emissive:new $(329733),emissiveIntensity:.1});this.planet=new P(e,l),this.planet.layers.enable(1),this.add(this.planet),this.createTrees(a)}createTrees(e){this.treeGroup=new q;const o=new le(.5,.8,4,6),n=new _({color:this.colors.trunk}),a=new he(2.5,8,8),r=new _({color:this.colors.leaves});e.forEach(l=>{const s=new q,i=new P(o,n);i.position.y=2,s.add(i);const c=new P(a,r);c.position.y=6,s.add(c),s.quaternion.setFromUnitVectors(new g(0,1,0),l.clone().normalize()),s.position.copy(l),s.scale.setScalar(.5+Math.random()*1.5),s.traverse(u=>{u.isMesh&&u.layers.enable(1)}),this.treeGroup.add(s)}),this.planet.add(this.treeGroup)}createWater(){const e=new H(this.waterLevel,128,128),o=new _({color:this.colors.water,transparent:!0,opacity:.6,roughness:.2,metalness:.5});this.water=new P(e,o),this.water.layers.enable(1),this.add(this.water)}createAtmosphere(){const e=new H(this.radius*1.2,64,64);this.atmoMat=new pe({vertexShader:`
        varying vec3 vWorldNormal;
        varying vec3 vWorldPosition;
        void main() {
          vWorldNormal = normalize(modelMatrix * vec4(normal, 0.0)).xyz;
          vec4 worldPos = modelMatrix * vec4(position, 1.0);
          vWorldPosition = worldPos.xyz;
          gl_Position = projectionMatrix * viewMatrix * worldPos;
        }
      `,fragmentShader:`
        uniform vec3 glowColor;
        uniform float intensity;
        uniform float power;
        uniform vec3 sunPosition;
        uniform float planetRadius;
        uniform float atmoRadius;
        varying vec3 vWorldNormal;
        varying vec3 vWorldPosition;
        void main() {
          vec3 viewDir = normalize(cameraPosition - vWorldPosition);
          vec3 sunDir = normalize(sunPosition - vWorldPosition);
          float dotNV = dot(vWorldNormal, viewDir);
          float d = atmoRadius * sqrt(1.0 - dotNV * dotNV);
          float density = smoothstep(atmoRadius, planetRadius, d);
          density = pow(density, power);
          float sunMix = dot(vWorldNormal, sunDir);
          float shadowMask = smoothstep(-0.4, 0.5, sunMix);
          shadowMask = mix(0.15, 1.0, shadowMask);
          float baseHaze = pow(max(0.0, dotNV), 3.0) * 0.5;
          vec3 color = glowColor;
          vec3 sunGlow = vec3(0.2, 0.3, 0.5) * clamp(sunMix, 0.0, 1.0) * density;
          color += sunGlow;
          float finalAlpha = (density + baseHaze) * shadowMask * intensity;
          finalAlpha *= smoothstep(0.0, 0.1, abs(dotNV));
          gl_FragColor = vec4(color, finalAlpha);
        }
      `,uniforms:{glowColor:{value:new $(8965375)},intensity:{value:.7},power:{value:2.6},sunPosition:{value:new g(0,0,0)},planetRadius:{value:this.radius},atmoRadius:{value:this.radius*1.2}},side:be,blending:ge,transparent:!0,depthWrite:!1});const o=new P(e,this.atmoMat);o.layers.enable(1),this.add(o);const n=new H(this.radius+10,64,64),a=new _({color:8965375,transparent:!0,opacity:.1,side:be}),r=new P(n,a);r.layers.enable(1),this.add(r)}createClouds(){const e=new H(this.radius+25,64,64),o=new _({color:16777215,transparent:!0,opacity:.15,depthWrite:!1,alphaMap:this.createCloudTexture()});this.clouds=new P(e,o),this.clouds.layers.enable(1),this.add(this.clouds)}createCloudTexture(){const e=document.createElement("canvas");e.width=512,e.height=512;const o=e.getContext("2d"),n=o.createImageData(512,512);for(let r=0;r<n.data.length;r+=4){const l=r/4%512,s=Math.floor(r/4/512),i=this.simplex.noise3d(l*.01,s*.01,0)*.5+.5,c=i>.8?(i-.8)*5*255:0;n.data[r]=n.data[r+1]=n.data[r+2]=255,n.data[r+3]=Math.min(255,c)}o.putImageData(n,0,0);const a=new De(e);return a.wrapS=a.wrapT=ve,a}createLocalLights(){this.skyLight=new rt(12315903,4008735,.8),this.skyLight.layers.enable(1),this.add(this.skyLight);const e=new lt;this.add(e),this.sunLight=new ct(16777215,4.5),this.sunLight.layers.enable(1),this.sunLight.target=e,this.add(this.sunLight)}update(e){const o=new g;this.planet.getWorldPosition(o);const a=new g().subVectors(e,o).normalize().clone().multiplyScalar(2e3);this.sunLight.position.copy(a),this.atmoMat&&this.atmoMat.uniforms.sunPosition.value.copy(e),this.clouds&&(this.clouds.rotation.y+=5e-5*60,this.clouds.rotation.x+=1e-5*60)}}const io=()=>{const t=new so;return{root:t,planet:t.planet,atmosphereGroup:t,update:e=>t.update(e)}},ro=()=>{const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),o=e.createRadialGradient(32,32,0,32,32,32);return o.addColorStop(0,"rgba(255, 255, 255, 1)"),o.addColorStop(.15,"rgba(255, 255, 255, 1)"),o.addColorStop(.3,"rgba(255, 255, 255, 0.8)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.4)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=o,e.fillRect(0,0,64,64),new De(t)},lo=()=>{const t=new Ee,e=[],o=[];for(let a=0;a<15e3;a++){const r=4e4+Math.random()*5e4,l=Math.random()*Math.PI*2,s=Math.acos(2*Math.random()-1);e.push(r*Math.sin(s)*Math.cos(l),r*Math.sin(s)*Math.sin(l),r*Math.cos(s));const i=Math.random();i<.1?o.push(1,.9,.7):i<.2?o.push(.85,.95,1):o.push(1,1,1)}t.setAttribute("position",new ke(e,3)),t.setAttribute("color",new ke(o,3));const n=new dt({size:2.5,map:ro(),vertexColors:!0,transparent:!0,opacity:1,sizeAttenuation:!0,depthWrite:!1,blending:ge});return new ut(t,n)},co=t=>{const e=new q,o=t.name==="木炉星"?0:Math.random()*Math.PI*2;e.userData={...t,angle:o};const n=t.isStar||Ze[t.name]?64:32,a=new H(t.size,n,n);let r,l=null;if(t.isStar){l=to(t.size),e.add(l),r=l.getObjectByName("SunSurface");const s=new Ue(16768392,3,5e4);e.add(s)}else if(t.name==="木炉星"){const s=io();e.add(s.root),r=s.planet,e.userData.atmosphere=s.atmosphereGroup,e.userData.updateModel=s.update}else{let s;const i=Lt(t.name);i?s=new _({map:i.diffuseMap,normalMap:i.normalMap,normalScale:new mt(1.5,1.5),roughnessMap:i.roughnessMap,roughness:.7,metalness:.1,emissive:new $(t.emissive),emissiveIntensity:.15}):s=new _({color:t.color,emissive:t.emissive,emissiveIntensity:.4,roughness:.6,metalness:.2}),r=new P(a,s),e.add(r)}if(e.userData.mesh=r,!t.isStar){const s=new q;Je[t.name]&&eo(t.name,t.size,s),r.add(s)}if(t.hasAtmosphere&&t.atmosphereThickness&&t.name!=="木炉星"){const s=_t[t.name]||{color:t.atmosphereColor||16777215,thickness:t.atmosphereThickness,intensity:.6,power:2.5},i=Nt(t.size,s);i.userData.isAtmosphere=!0,e.add(i),e.userData.atmosphere=i}if(t.hasBlackHole){const s=t.blackHoleSize||t.size*.15,i=new H(s,32,32),c=new me({color:0}),u=new P(i,c);u.position.set(0,0,0),e.add(u);const y=new pt(s*1.2,s*2.5,64),M=new pe({vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying vec2 vUv;
        void main() {
          float dist = length(vUv - 0.5) * 2.0;
          float alpha = smoothstep(0.0, 0.5, dist) * smoothstep(1.0, 0.6, dist);
          vec3 color = mix(vec3(0.5, 0.3, 1.0), vec3(0.2, 0.1, 0.5), dist);
          gl_FragColor = vec4(color, alpha * 0.7);
        }
      `,transparent:!0,side:Ae,depthWrite:!1,blending:ge}),C=new P(y,M);C.rotation.x=Math.PI/2,e.add(C);const h=new H(s*1.8,32,32),w=new me({color:4465322,transparent:!0,opacity:.25,side:be});e.add(new P(h,w))}if(t.isComet){const s=new he(t.size*.6,t.size*5,8),i=new me({color:6741503,transparent:!0,opacity:.3,side:Ae}),c=new P(s,i);c.rotation.x=Math.PI/2,c.position.z=t.size*2.5,e.add(c),e.userData.tail=c}if(t.isQuantum){const s=t.size+(t.atmosphereThickness||130),i=new H(s,48,48),c=new pe({vertexShader:`
        varying vec3 vNormal;
        varying vec3 vViewPosition;
        void main() {
          vNormal = normalize(normalMatrix * normal);
          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
          vViewPosition = -mvPosition.xyz;
          gl_Position = projectionMatrix * mvPosition;
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying vec3 vViewPosition;
        void main() {
          vec3 viewDir = normalize(vViewPosition);
          float vDotN = max(0.0, abs(dot(viewDir, vNormal)));
          
          // 增加 vDotN 因子，使雾气向边缘自然淡出
          float rim = 1.0 - vDotN;
          float alpha = (0.85 + rim * 0.15) * vDotN * 1.5;
          
          vec3 fogColor = vec3(0.35, 0.35, 0.4);
          gl_FragColor = vec4(fogColor, alpha);
        }
      `,transparent:!0,side:Te,depthWrite:!1}),u=new P(i,c);e.add(u);const y=new H(t.size*1.05,32,32),M=new me({color:4473941,transparent:!0,opacity:.95});e.add(new P(y,M));const C=new H(s*1.08,32,32),h=new me({color:5592422,transparent:!0,opacity:.1,side:be});e.add(new P(C,h))}return{group:e,sunCoronaGroup:l}},We=(t,e=!1)=>{const n=new Ee,a=[];for(let s=0;s<=128;s++){const i=s/128*Math.PI*2;a.push(Math.cos(i)*t,0,Math.sin(i)*t)}n.setAttribute("position",new ke(a,3));const r=e?new He({color:4478310,transparent:!0,opacity:.3,dashSize:2,gapSize:1}):new ht({color:3359829,transparent:!0,opacity:.25}),l=new Xe(n,r);return e&&l.computeLineDistances(),l},uo=(t,e)=>{const n=new Ee,a=[],r=Math.sqrt(t*t-e*e);for(let i=0;i<=128;i++){const c=i/128*Math.PI*2;a.push(Math.cos(c)*t-r,0,Math.sin(c)*e)}n.setAttribute("position",new ke(a,3));const l=new He({color:4491434,transparent:!0,opacity:.35,dashSize:1.5,gapSize:1}),s=new Xe(n,l);return s.computeLineDistances(),s},mo=t=>{const e=new q,o=new he(1.5,6,8),n=new _({color:13404228,emissive:4465169,emissiveIntensity:.3,roughness:.4,metalness:.6}),a=new P(o,n);a.rotation.x=Math.PI/2,e.add(a);const r=new Se(8,.3,2),l=new _({color:8939059,roughness:.5,metalness:.4}),s=new P(r,l);s.position.z=1,e.add(s);const i=new H(1,16,16,0,Math.PI*2,0,Math.PI/2),c=new _({color:8965375,transparent:!0,opacity:.7,roughness:.1,metalness:.8}),u=new P(i,c);u.rotation.x=-Math.PI/2,u.position.z=-1.5,e.add(u);const y=new le(.8,1,1.5,8),M=new _({color:4473924,roughness:.3,metalness:.8}),C=new P(y,M);C.rotation.x=Math.PI/2,C.position.z=3.5,e.add(C);const h=(f,b,v=1)=>{const m=new he(.5*v,2*v,8),S=new me({color:16737792,transparent:!0,opacity:0,depthTest:!1}),x=new P(m,S);return x.position.copy(f),x.rotation.set(b.x,b.y,b.z),x.renderOrder=999,e.add(x),x},w={back:h(new g(0,0,5),new g(-Math.PI/2,0,0),1.2),front:h(new g(0,0,-4),new g(Math.PI/2,0,0),.8),left:h(new g(2,0,0),new g(0,0,Math.PI/2),.6),right:h(new g(-2,0,0),new g(0,0,-Math.PI/2),.6),bottom:h(new g(0,2,1),new g(0,0,0),.6),top:h(new g(0,-2,1),new g(Math.PI,0,0),.6)};e.userData.thrusters=w;const d=new Ue(16777130,.5,50);return d.position.set(0,0,-2.5),e.add(d),e.position.copy(t),e},Qe=(t,e)=>{const o=t==null?void 0:t.userData.thrusters;if(!o)return;const n=.8+Math.random()*.4;o.back.material.opacity=e.forward?.9:0,e.forward&&(o.back.scale.y=n),o.front.material.opacity=e.backward?.8:0,e.backward&&(o.front.scale.y=n),o.left.material.opacity=e.left?.7:0,e.left&&(o.left.scale.y=n),o.right.material.opacity=e.right?.7:0,e.right&&(o.right.scale.y=n),o.top.material.opacity=e.up?.7:0,e.up&&(o.top.scale.y=n),o.bottom.material.opacity=e.down?.7:0,e.down&&(o.bottom.scale.y=n)},po=(t,e)=>{const o=new g;return e.forEach(n=>{const a=n.userData;if(!a.mass)return;const r=new g().subVectors(n.position,t),l=r.length();if(l<a.size)return;const s=At*a.mass/(l*l);r.normalize().multiplyScalar(s),o.add(r)}),o},Ge=(t,e)=>{let o=null,n=1/0;return e.forEach(a=>{const r=a.userData;if(r.isStar)return;const l=t.distanceTo(a.position)-r.size;l<n&&(n=l,o=a)}),{body:o,distance:n}},we=(t,e,o)=>{const n=t.userData;if(n.isStar)return new g(0,0,0);const a=t.position.clone(),r=.016;let l,s;if(n.isComet&&n.orbitA&&n.orbitB){const i=Math.sqrt(n.orbitA*n.orbitA-n.orbitB*n.orbitB),c=n.angle+n.orbitSpeed*r*60;l=Math.cos(c)*n.orbitA-i,s=Math.sin(c)*n.orbitB}else if(n.isTwin){const i=o+$e*r*60,c=Math.cos(i)*n.orbitRadius,u=Math.sin(i)*n.orbitRadius,y=400,M=i*10;l=c+Math.cos(M)*y*n.twinSide,s=u+Math.sin(M)*y*n.twinSide}else if(n.moonOf){const i=e.find(c=>c.userData.name===n.moonOf);if(i){const c=we(i,e,o),u=(n.moonAngle||0)+n.moonOrbitSpeed*r*60,y=-Math.sin(u)*n.moonOrbitRadius*n.moonOrbitSpeed*60,M=Math.cos(u)*n.moonOrbitRadius*n.moonOrbitSpeed*60;return new g(c.x+y,0,c.z+M)}return new g(0,0,0)}else if(n.orbitRadius){const i=n.angle+n.orbitSpeed*r*60;l=Math.cos(i)*n.orbitRadius,s=Math.sin(i)*n.orbitRadius}else return new g(0,0,0);return new g((l-a.x)/r,0,(s-a.z)/r)},je=(t,e,o,n,a)=>{let r=o+$e*t*60,l=a;return e.forEach(s=>{const i=s.userData;if(i.isQuantum){const c=Ne[n],u=e.find(y=>y.userData.name===c);u&&(l+=i.moonOrbitSpeed*t*60,s.position.x=u.position.x+Math.cos(l)*i.moonOrbitRadius,s.position.y=Math.sin(l)*i.moonOrbitRadius*.3,s.position.z=u.position.z+Math.sin(l)*i.moonOrbitRadius);return}if(i.moonOf){const c=e.find(u=>u.userData.name===i.moonOf);c&&(i.moonAngle=(i.moonAngle||0)+i.moonOrbitSpeed*t*60,s.position.x=c.position.x+Math.cos(i.moonAngle)*i.moonOrbitRadius,s.position.y=Math.sin(i.moonAngle)*i.moonOrbitRadius*.2,s.position.z=c.position.z+Math.sin(i.moonAngle)*i.moonOrbitRadius);return}if(i.orbitRadius>0||i.isComet)if(i.angle+=i.orbitSpeed*t*60,i.isComet&&i.orbitA&&i.orbitB){const c=Math.sqrt(i.orbitA*i.orbitA-i.orbitB*i.orbitB);if(s.position.x=Math.cos(i.angle)*i.orbitA-c,s.position.z=Math.sin(i.angle)*i.orbitB,i.tail){const u=i.orbitA*Math.sin(i.angle),y=-i.orbitB*Math.cos(i.angle);s.rotation.y=Math.atan2(u,y)}}else if(i.isTwin){const c=Math.cos(r)*i.orbitRadius,u=Math.sin(r)*i.orbitRadius,y=400,M=r*10;s.position.x=c+Math.cos(M)*y*i.twinSide,s.position.z=u+Math.sin(M)*y*i.twinSide}else s.position.x=Math.cos(i.angle)*i.orbitRadius,s.position.z=Math.sin(i.angle)*i.orbitRadius;i.mesh&&i.rotationSpeed&&(i.mesh.rotation.y+=i.rotationSpeed*t*60)}),{twinSystemAngle:r,quantumAngle:l}};let Le=0;const ho=t=>{const e=Me({position:new g().copy(t),velocity:new g(0,0,0),rotation:new Ke(0,0,0),thrust:25,rotationSpeed:1.5,maxSpeed:500,fuel:100,isLanded:!1,landedOn:null,landedLocalDir:null,landedLocalQuaternion:new ee,isMatchingVelocity:!1,targetVelocity:new g(0,0,0),matchingTarget:null,initialVelocityDiff:0}),o=Me({forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rollLeft:!1,rollRight:!1,pitchUp:!1,pitchDown:!1,boost:!1,matchVelocity:!1}),n=Me({speed:0,altitude:0,nearestBody:null,nearestDistance:0,isThrusting:!1,isMatchingVelocity:!1,matchingProgress:0}),a=xe("first");let r=null;const l=h=>{r=h},s=(h,w)=>{if(e.isMatchingVelocity){e.isMatchingVelocity=!1,e.matchingTarget=null,e.initialVelocityDiff=0;return}const d=Ge(e.position,h);d.body&&(e.isMatchingVelocity=!0,e.matchingTarget=d.body,e.targetVelocity.copy(we(d.body,h,w)),e.initialVelocityDiff=new g().subVectors(e.targetVelocity,e.velocity).length())},i=(h,w,d)=>{if(!e.isMatchingVelocity||!e.matchingTarget)return;const f=we(e.matchingTarget,w,d);e.targetVelocity.copy(f);const b=new g().subVectors(e.targetVelocity,e.velocity),v=b.length();if(v<.5){e.velocity.copy(e.targetVelocity),e.isMatchingVelocity=!1,e.matchingTarget=null;return}const S=25*h;if(v<=S)e.velocity.copy(e.targetVelocity);else{const x=b.normalize().multiplyScalar(S);e.velocity.add(x)}n.matchingProgress=(1-v/e.initialVelocityDiff)*100},c=(h,w)=>{if(!e.isLanded||!e.landedOn)return;const d=e.landedOn,f=new g().subVectors(e.position,d.position).normalize(),b=we(d,h,w);e.velocity.copy(b).add(f.multiplyScalar(2));const v=d.userData.rotationSpeed||0,m=d.userData.size+.5,S=new g(0,1,0),x=new g(f.x,0,f.z);if(x.lengthSq()>.001){x.normalize();const D=new g().crossVectors(S,x).normalize(),L=Math.sqrt(f.x*f.x+f.z*f.z)*m*v;e.velocity.add(D.multiplyScalar(L))}e.isLanded=!1,e.landedOn=null,e.landedLocalDir=null};return{ship:e,controls:o,hud:n,viewMode:a,setShipMesh:l,matchVelocityWithNearest:s,launch:c,updateShip:(h,w,d)=>{var I;if(Le=d,e.isLanded&&e.landedOn){const V=e.landedOn,R=V.userData.mesh,z=R?R.rotation.y:0,A=new ee().setFromAxisAngle(new g(0,1,0),z),E=e.landedLocalDir.clone().applyQuaternion(A);e.position.copy(V.position).add(E.multiplyScalar(V.userData.size+.5));const N=A.clone().multiply(e.landedLocalQuaternion);if(e.rotation.setFromQuaternion(N),n.speed="0",n.altitude="0",o.forward||o.backward||o.left||o.right){const B=7*(o.boost?3:1)*h,W=(o.forward?1:0)-(o.backward?1:0),X=(o.right?1:0)-(o.left?1:0),T=new g(0,0,-1).applyQuaternion(e.landedLocalQuaternion),O=new g(1,0,0).applyQuaternion(e.landedLocalQuaternion),K=new g().addScaledVector(T,W).addScaledVector(O,X).normalize();if(K.lengthSq()>.001){const Y=e.landedLocalDir.clone().normalize(),Z=new g().crossVectors(Y,K).normalize(),J=B/(V.userData.size+.5),te=new ee().setFromAxisAngle(Z,J);e.landedLocalDir.applyQuaternion(te),e.landedLocalQuaternion.premultiply(te)}}o.up&&c(w,d),r&&(r.position.copy(e.position),r.rotation.copy(e.rotation),Qe(r,o));return}const f=new ee().setFromEuler(e.rotation),b=new g(0,0,-1).applyQuaternion(f),v=new g(1,0,0).applyQuaternion(f),m=new g(0,1,0).applyQuaternion(f),S=o.boost?2.5:1;o.forward&&e.velocity.add(b.clone().multiplyScalar(e.thrust*S*h)),o.backward&&e.velocity.add(b.clone().multiplyScalar(-e.thrust*.5*h)),o.left&&e.velocity.add(v.clone().multiplyScalar(-e.thrust*.5*h)),o.right&&e.velocity.add(v.clone().multiplyScalar(e.thrust*.5*h)),o.up&&e.velocity.add(m.clone().multiplyScalar(e.thrust*.5*h)),o.down&&e.velocity.add(m.clone().multiplyScalar(-e.thrust*.5*h));const x=po(e.position,w);e.velocity.add(x.multiplyScalar(h)),i(h,w,d),e.velocity.length()>e.maxSpeed&&e.velocity.normalize().multiplyScalar(e.maxSpeed),e.position.add(e.velocity.clone().multiplyScalar(h)),r&&(r.position.copy(e.position),r.rotation.copy(e.rotation),Qe(r,o));const k=Ge(e.position,w);let L=e.velocity.length();if(k.body){const V=we(k.body,w,Le);L=new g().subVectors(e.velocity,V).length()}if(n.speed=L.toFixed(0),n.nearestBody=((I=k.body)==null?void 0:I.userData.name)||null,n.nearestDistance=k.distance.toFixed(0),n.altitude=k.distance.toFixed(0),n.isThrusting=o.forward||o.backward||o.left||o.right||o.up||o.down,n.isMatchingVelocity=e.isMatchingVelocity,k.distance<.5&&k.body){e.isLanded=!0,e.landedOn=k.body,e.isMatchingVelocity=!1,e.matchingTarget=null,e.initialVelocityDiff=0;const V=k.body.userData.mesh?k.body.userData.mesh.rotation.y:0;e.landedLocalDir=new g().subVectors(e.position,k.body.position).normalize(),e.landedLocalDir.applyAxisAngle(new g(0,1,0),-V);const R=new ee().setFromEuler(e.rotation),z=new ee().setFromAxisAngle(new g(0,1,0),V);e.landedLocalQuaternion.copy(z.invert().multiply(R));const A=we(k.body,w,Le);e.velocity.copy(A)}},updateCamera:(h,w)=>{const d=new ee;d.setFromEuler(e.rotation),new g(0,0,-1).applyQuaternion(d);const f=new g(0,1,0).applyQuaternion(d),b=new g(0,0,1).applyQuaternion(d);if(a.value==="first")h.position.copy(e.position),h.quaternion.copy(d),r&&(r.visible=!1);else if(a.value==="third"){const v=b.clone().multiplyScalar(40).add(f.clone().multiplyScalar(15));h.position.copy(e.position).add(v),h.lookAt(e.position),r&&(r.visible=!0)}else if(a.value==="orbit"){const v=Ge(e.position,w);if(v.body){const m=v.body.position.clone(),S=new g().subVectors(e.position,m).normalize();h.position.copy(m).add(S.multiplyScalar(v.body.userData.size*4+10)),h.lookAt(e.position),r&&(r.visible=!0)}}},handleMouseMove:(h,w)=>{if(!w)return;const d=.002;if(e.isLanded&&e.landedOn){const m=e.landedLocalDir.clone().normalize(),S=new g(0,0,-1).applyQuaternion(e.landedLocalQuaternion);let x=new g().crossVectors(S,m).normalize();if(x.lengthSq()<.001){const I=new g(0,1,0).applyQuaternion(e.landedLocalQuaternion);x=new g().crossVectors(I,m).normalize()}const D=new ee().setFromAxisAngle(m,-h.movementX*d),k=new ee().setFromAxisAngle(x,-h.movementY*d);e.landedLocalQuaternion.premultiply(D),e.landedLocalQuaternion.multiply(k);const L=new g(0,0,-1).applyQuaternion(e.landedLocalQuaternion);if(Math.abs(L.dot(m))<.999){const I=new g().crossVectors(L,m).normalize(),V=new g().crossVectors(m,I).normalize(),R=new ft().makeBasis(I,m,V.negate());e.landedLocalQuaternion.setFromRotationMatrix(R)}return}const f=new ee().setFromEuler(e.rotation),b=new ee().setFromAxisAngle(new g(0,1,0),-h.movementX*d),v=new ee().setFromAxisAngle(new g(1,0,0),-h.movementY*d);f.multiply(b),f.multiply(v),e.rotation.setFromQuaternion(f)},cycleViewMode:()=>{const h=["first","third","orbit"],w=h.indexOf(a.value);a.value=h[(w+1)%h.length]}}},fo=()=>{const t=xe(!1),e=xe(""),o=Me({leftX:0,leftY:0,rightX:0,rightY:0}),n=Me({a:!1,b:!1,x:!1,y:!1,lb:!1,rb:!1,lt:0,rt:0,back:!1,start:!1,leftStick:!1,rightStick:!1,up:!1,down:!1,left:!1,right:!1}),a=.15,r=w=>Math.abs(w)<a?0:(w>0?1:-1)*(Math.abs(w)-a)/(1-a),l=()=>{var f,b,v,m,S,x,D,k,L,I,V,R,z,A,E,N;const w=navigator.getGamepads();let d=null;for(const B of w)if(B&&B.connected){d=B;break}if(!d){t.value=!1,e.value="";return}t.value=!0,e.value=d.id,o.leftX=r(d.axes[0]||0),o.leftY=r(d.axes[1]||0),o.rightX=r(d.axes[2]||0),o.rightY=r(d.axes[3]||0),n.a=((f=d.buttons[0])==null?void 0:f.pressed)||!1,n.b=((b=d.buttons[1])==null?void 0:b.pressed)||!1,n.x=((v=d.buttons[2])==null?void 0:v.pressed)||!1,n.y=((m=d.buttons[3])==null?void 0:m.pressed)||!1,n.lb=((S=d.buttons[4])==null?void 0:S.pressed)||!1,n.rb=((x=d.buttons[5])==null?void 0:x.pressed)||!1,n.lt=((D=d.buttons[6])==null?void 0:D.value)||0,n.rt=((k=d.buttons[7])==null?void 0:k.value)||0,n.back=((L=d.buttons[8])==null?void 0:L.pressed)||!1,n.start=((I=d.buttons[9])==null?void 0:I.pressed)||!1,n.leftStick=((V=d.buttons[10])==null?void 0:V.pressed)||!1,n.rightStick=((R=d.buttons[11])==null?void 0:R.pressed)||!1,n.up=((z=d.buttons[12])==null?void 0:z.pressed)||!1,n.down=((A=d.buttons[13])==null?void 0:A.pressed)||!1,n.left=((E=d.buttons[14])==null?void 0:E.pressed)||!1,n.right=((N=d.buttons[15])==null?void 0:N.pressed)||!1},s=w=>{w.forward=o.leftY<-.1,w.backward=o.leftY>.1,w.left=o.leftX<-.1,w.right=o.leftX>.1,w.up=n.rt>.1||n.a,w.down=n.lt>.1,w.rollLeft=n.lb,w.rollRight=n.rb,w.boost=n.leftStick},i=()=>({yaw:o.rightX*.12,pitch:o.rightY*.12});let c=null;const u=()=>{l(),c=requestAnimationFrame(u)},y=w=>{console.log("Gamepad connected:",w.gamepad.id),t.value=!0,e.value=w.gamepad.id},M=w=>{console.log("Gamepad disconnected:",w.gamepad.id),t.value=!1,e.value=""};return{gamepadConnected:t,gamepadName:e,axes:o,buttons:n,mapToControls:s,getRotationInput:i,startPolling:()=>{typeof window>"u"||(window.addEventListener("gamepadconnected",y),window.addEventListener("gamepaddisconnected",M),u())},stopPolling:()=>{c&&(cancelAnimationFrame(c),c=null),typeof window<"u"&&(window.removeEventListener("gamepadconnected",y),window.removeEventListener("gamepaddisconnected",M))}}},wo={class:"backdrop-blur-sm bg-black/50 rounded-xl border border-cyan-500/30 p-4 min-w-[220px]"},vo={class:"text-xs text-cyan-300/60 uppercase tracking-wider mb-3 flex items-center gap-2"},go={key:0,class:"px-1.5 py-0.5 bg-orange-500/30 text-orange-300 rounded text-[10px] animate-pulse"},yo={key:1,class:"px-1.5 py-0.5 bg-cyan-500/30 text-cyan-300 rounded text-[10px] animate-pulse"},xo={class:"space-y-2 text-sm"},bo={class:"flex justify-between"},Mo={class:"text-cyan-100 font-mono"},So={class:"flex justify-between"},ko={class:"text-cyan-100 font-mono"},Po={key:0,class:"flex justify-between items-center"},Do={class:"text-amber-200"},Co={key:1,class:"flex justify-between"},Ao={class:"text-amber-200"},Ro={key:2,class:"mt-2 pt-2 border-t border-cyan-500/20"},zo={class:"flex justify-between items-center"},Vo={class:"text-cyan-300 font-mono text-xs"},Go={class:"mt-1.5 h-1.5 bg-cyan-900/50 rounded-full overflow-hidden"},Lo={class:"mt-3 pt-3 border-t border-cyan-500/20"},No={class:"flex justify-between text-xs"},Io={class:"text-cyan-100/80 font-mono text-[10px]"},To={__name:"SpaceshipHUD",props:{hud:{type:Object,required:!0},ship:{type:Object,required:!0}},setup(t){return(e,o)=>{var n,a;return ne(),se("div",wo,[p("div",vo,[o[0]||(o[0]=Q(" 飞船状态 ",-1)),t.hud.isThrusting?(ne(),se("span",go," 推进中 ")):de("",!0),t.hud.isMatchingVelocity?(ne(),se("span",yo," 速度同步 ")):de("",!0)]),p("div",xo,[p("div",bo,[o[1]||(o[1]=p("span",{class:"text-cyan-200/60"},"速度",-1)),p("span",Mo,ce(t.hud.speed)+" m/s",1)]),p("div",So,[o[2]||(o[2]=p("span",{class:"text-cyan-200/60"},"距离",-1)),p("span",ko,ce(t.hud.altitude)+" m",1)]),t.ship.isLanded?(ne(),se("div",Po,[o[3]||(o[3]=p("span",{class:"text-green-300 flex items-center gap-1.5"}," 已降落 ",-1)),p("span",Do,ce((n=t.ship.landedOn)==null?void 0:n.userData.name),1)])):t.hud.nearestBody?(ne(),se("div",Co,[o[4]||(o[4]=p("span",{class:"text-cyan-200/60"},"最近天体",-1)),p("span",Ao,ce(t.hud.nearestBody),1)])):de("",!0),t.hud.isMatchingVelocity&&!t.ship.isLanded?(ne(),se("div",Ro,[p("div",zo,[o[5]||(o[5]=p("span",{class:"text-cyan-200/60"},"同步中",-1)),p("span",Vo,ce((a=t.ship.matchingTarget)==null?void 0:a.userData.name),1)]),p("div",Go,[p("div",{class:"h-full bg-gradient-to-r from-cyan-500 to-cyan-300 transition-all duration-150",style:bt({width:`${t.ship.initialVelocityDiff>.5?Math.max(0,100-Math.sqrt(Math.pow(t.ship.velocity.x-t.ship.targetVelocity.x,2)+Math.pow(t.ship.velocity.z-t.ship.targetVelocity.z,2))/t.ship.initialVelocityDiff*100):100}%`})},null,4)])])):de("",!0)]),p("div",Lo,[p("div",No,[o[6]||(o[6]=p("span",{class:"text-cyan-200/60"},"坐标 (m)",-1)),p("span",Io,ce(Math.round(t.ship.position.x))+", "+ce(Math.round(t.ship.position.y))+", "+ce(Math.round(t.ship.position.z)),1)])])])}}},_o={key:0,class:"space-y-2"},Eo={key:0,class:"backdrop-blur-sm bg-black/50 rounded-xl border border-cyan-500/30 p-4 text-xs"},Fo={key:1,class:"backdrop-blur-sm bg-black/50 rounded-xl border border-green-500/30 p-4 text-xs"},Oo={__name:"ControlsPanel",props:{visible:{type:Boolean,default:!0},gamepadConnected:{type:Boolean,default:!1}},setup(t){return(e,o)=>(ne(),Mt(St,{"enter-active-class":"transition-all duration-300 ease-out","leave-active-class":"transition-all duration-200 ease-in","enter-from-class":"opacity-0 translate-x-4","leave-to-class":"opacity-0 translate-x-4"},{default:Ye(()=>[t.visible?(ne(),se("div",_o,[t.gamepadConnected?de("",!0):(ne(),se("div",Eo,[...o[0]||(o[0]=[p("div",{class:"text-cyan-300/60 uppercase tracking-wider mb-3"},"键盘控制 (H 隐藏)",-1),p("div",{class:"grid grid-cols-2 gap-x-6 gap-y-1 text-cyan-200/80"},[p("div",null,[p("span",{class:"text-cyan-400"},"鼠标"),Q(" 视角控制")]),p("div",null,[p("span",{class:"text-cyan-400"},"点击"),Q(" 锁定鼠标")]),p("div",null,[p("span",{class:"text-cyan-400"},"W/S"),Q(" 前进/后退")]),p("div",null,[p("span",{class:"text-cyan-400"},"A/D"),Q(" 左移/右移")]),p("div",null,[p("span",{class:"text-cyan-400"},"Space"),Q(" 上升")]),p("div",null,[p("span",{class:"text-cyan-400"},"Ctrl"),Q(" 下降")]),p("div",null,[p("span",{class:"text-cyan-400"},"Q/E"),Q(" 左转/右转")]),p("div",null,[p("span",{class:"text-cyan-400"},"↑/↓"),Q(" 俯仰")]),p("div",null,[p("span",{class:"text-cyan-400"},"Shift"),Q(" 加速")]),p("div",null,[p("span",{class:"text-cyan-400"},"X"),Q(" 速度同步")]),p("div",null,[p("span",{class:"text-cyan-400"},"F"),Q(" 起飞")]),p("div",null,[p("span",{class:"text-cyan-400"},"V"),Q(" 切换视角")])],-1)])])),t.gamepadConnected?(ne(),se("div",Fo,[...o[1]||(o[1]=[p("div",{class:"text-green-300/60 uppercase tracking-wider mb-3"},"手柄控制",-1),p("div",{class:"grid grid-cols-2 gap-x-6 gap-y-1 text-green-200/80"},[p("div",null,[p("span",{class:"text-green-400"},"左摇杆"),Q(" 移动")]),p("div",null,[p("span",{class:"text-green-400"},"右摇杆"),Q(" 视角")]),p("div",null,[p("span",{class:"text-green-400"},"RT"),Q(" 上升")]),p("div",null,[p("span",{class:"text-green-400"},"LT"),Q(" 下降")]),p("div",null,[p("span",{class:"text-green-400"},"LB/RB"),Q(" 翻滚")]),p("div",null,[p("span",{class:"text-green-400"},"左摇杆按下"),Q(" 加速")]),p("div",null,[p("span",{class:"text-green-400"},"A"),Q(" 起飞/上升")]),p("div",null,[p("span",{class:"text-green-400"},"X"),Q(" 速度同步")]),p("div",null,[p("span",{class:"text-green-400"},"B"),Q(" 切换视角")]),p("div",null,[p("span",{class:"text-green-400"},"Start"),Q(" 隐藏说明")])],-1)])])):de("",!0)])):de("",!0)]),_:1}))}},Bo={class:"fixed inset-0 w-full h-full overflow-hidden bg-[#020206] outline-none",tabindex:"0"},Wo={key:0,class:"absolute inset-0 flex items-center justify-center z-50 bg-[#020206]"},Qo={class:"absolute bottom-4 left-4 md:bottom-6 md:left-6 z-10 space-y-2"},jo={class:"absolute bottom-4 right-4 md:bottom-6 md:right-6 z-10"},qo={class:"absolute bottom-4 left-1/2 -translate-x-1/2 z-10 flex gap-2 items-center"},Uo={key:0,class:"px-3 py-1.5 rounded-lg bg-black/50 backdrop-blur-sm border border-green-500/30 text-green-300/80 text-xs flex items-center gap-1.5"},Ho={__name:"SpaceshipSimulator",setup(t){const e=xe(null),o=xe(!0),n=xe(!0);let a,r,l,s=null,i=0,c=[],u=Math.random()*Math.PI*2,y=0,M=0,C=null,h=new g(0,0,0),w=0,d=!1,f=null;const b=new g(8943,50,50),{ship:v,controls:m,hud:S,viewMode:x,setShipMesh:D,matchVelocityWithNearest:k,launch:L,updateShip:I,updateCamera:V,handleMouseMove:R,cycleViewMode:z}=ho(b),{gamepadConnected:A,buttons:E,mapToControls:N,getRotationInput:B,startPolling:W,stopPolling:X}=fo();let T={x:!1,b:!1,start:!1};const O=()=>{a=new wt,r=new vt(45,e.value.clientWidth/e.value.clientHeight,.5,15e4),l=new gt({antialias:!0,alpha:!0}),l.setSize(e.value.clientWidth,e.value.clientHeight),l.setPixelRatio(Math.min(window.devicePixelRatio,2)),l.toneMapping=yt,l.toneMappingExposure=1,e.value.appendChild(l.domElement),a.add(lo());const G=new xt(3359829,.6);a.add(G);let j=!1;Rt.forEach(U=>{const{group:ye,sunCoronaGroup:Ce}=co(U);a.add(ye),c.push(ye),Ce&&(C=Ce),U.orbitRadius>0&&!U.isTwin&&!U.isComet&&!U.isQuantum&&a.add(We(U.orbitRadius)),U.isTwin&&!j&&(a.add(We(U.orbitRadius)),j=!0),U.isComet&&U.orbitA&&U.orbitB&&a.add(uo(U.orbitA,U.orbitB))}),f=mo(v.position),D(f),a.add(f);const ae=je(.016,c,u,y,M);u=ae.twinSystemAngle,M=ae.quantumAngle;const F=c.find(U=>U.userData.name==="木炉星");if(F){const U=F.position,ye=F.userData.size;v.position.set(U.x,U.y+ye+.5,U.z),f.position.copy(v.position),v.isLanded=!0,v.landedOn=F;const Ce=F.userData.mesh?F.userData.mesh.rotation.y:0;v.landedLocalDir=new g(0,1,0);const Fe=new ee().setFromEuler(new Ke(0,0,0)),et=new ee().setFromAxisAngle(new g(0,1,0),Ce);v.landedLocalQuaternion.copy(et.invert().multiply(Fe)),v.rotation.setFromQuaternion(Fe);const tt=we(F,c,u);v.velocity.copy(tt)}o.value=!1},K=G=>{s=requestAnimationFrame(K);const j=Math.min((G-i)/1e3,.1);if(i=G,w+=j,A.value){N(m);const F=B();if(Math.abs(F.yaw)>.01||Math.abs(F.pitch)>.01){const ye={movementX:F.yaw/.002,movementY:F.pitch/.002};R(ye,!0)}E.b&&!T.b&&z(),E.x&&!T.x&&k(c,u),E.start&&!T.start&&(n.value=!n.value),T.x=E.x,T.b=E.b,T.start=E.start}const ae=je(j,c,u,y,M);u=ae.twinSystemAngle,M=ae.quantumAngle,I(j,c,u),V(r,c),C&&oo(C,w),c.forEach(F=>{F.userData.atmosphere&&Tt(F.userData.atmosphere,h),F.userData.updateModel&&F.userData.updateModel(h)}),l.render(a,r)},Y=G=>{switch(G.code){case"KeyW":m.forward=!0;break;case"KeyS":m.backward=!0;break;case"KeyA":m.left=!0;break;case"KeyD":m.right=!0;break;case"Space":m.up=!0;break;case"ControlLeft":case"ControlRight":m.down=!0;break;case"KeyQ":m.rollLeft=!0;break;case"KeyE":m.rollRight=!0;break;case"ArrowUp":m.pitchUp=!0;break;case"ArrowDown":m.pitchDown=!0;break;case"ShiftLeft":case"ShiftRight":m.boost=!0;break;case"KeyX":k(c,u);break;case"KeyF":L(c,u);break;case"KeyH":n.value=!n.value;break;case"KeyV":z();break}},Z=G=>{switch(G.code){case"KeyW":m.forward=!1;break;case"KeyS":m.backward=!1;break;case"KeyA":m.left=!1;break;case"KeyD":m.right=!1;break;case"Space":m.up=!1;break;case"ControlLeft":case"ControlRight":m.down=!1;break;case"KeyQ":m.rollLeft=!1;break;case"KeyE":m.rollRight=!1;break;case"ArrowUp":m.pitchUp=!1;break;case"ArrowDown":m.pitchDown=!1;break;case"ShiftLeft":case"ShiftRight":m.boost=!1;break}},J=()=>{e.value&&(r.aspect=e.value.clientWidth/e.value.clientHeight,r.updateProjectionMatrix(),l.setSize(e.value.clientWidth,e.value.clientHeight))},te=G=>{R(G,d)},ie=()=>{d=document.pointerLockElement===e.value},re=()=>{!d&&e.value&&e.value.requestPointerLock()},oe=()=>{if(document.visibilityState==="visible"){let G;do G=Math.floor(Math.random()*Ne.length);while(G===y&&Ne.length>1);y=G,M=Math.random()*Math.PI*2}};return Pt(()=>{typeof window<"u"&&e.value&&(O(),i=performance.now(),K(i),window.addEventListener("resize",J),window.addEventListener("keydown",Y),window.addEventListener("keyup",Z),document.addEventListener("visibilitychange",oe),document.addEventListener("pointerlockchange",ie),document.addEventListener("mousemove",te),e.value.addEventListener("click",re),W(),e.value.focus())}),Dt(()=>{s&&cancelAnimationFrame(s),X(),window.removeEventListener("resize",J),window.removeEventListener("keydown",Y),window.removeEventListener("keyup",Z),document.removeEventListener("visibilitychange",oe),document.removeEventListener("pointerlockchange",ie),document.removeEventListener("mousemove",te),e.value&&e.value.removeEventListener("click",re),l&&l.dispose()}),(G,j)=>(ne(),se("div",Bo,[o.value?(ne(),se("div",Wo,[...j[1]||(j[1]=[p("div",{class:"text-center"},[p("div",{class:"w-16 h-16 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin mx-auto mb-4"}),p("div",{class:"text-amber-200/80 text-lg tracking-widest font-light"},"初始化飞船系统...")],-1)])])):de("",!0),p("div",{ref_key:"containerRef",ref:e,class:"w-full h-full"},null,512),j[3]||(j[3]=Be('<a href="/workshop/" class="absolute top-4 left-4 md:top-6 md:left-6 z-10 flex items-center gap-2 px-3 py-2 rounded-lg bg-black/50 backdrop-blur-sm border border-amber-500/30 text-amber-200/80 hover:text-amber-100 hover:bg-black/70 hover:border-amber-500/50 transition-all duration-300 group" data-v-8f16640b><svg class="w-5 h-5 transform group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-8f16640b><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" data-v-8f16640b></path></svg><span class="text-sm tracking-wide" data-v-8f16640b>返回</span></a><div class="absolute top-4 right-4 md:top-6 md:right-6 z-10 text-right" data-v-8f16640b><div class="text-xl md:text-2xl font-bold text-amber-200 tracking-wider drop-shadow-[0_0_20px_rgba(251,191,36,0.3)]" data-v-8f16640b> OUTER WILDS </div><div class="text-xs md:text-sm text-amber-200/60 mt-1 tracking-wide" data-v-8f16640b> SPACECRAFT SIMULATOR </div></div>',2)),p("div",Qo,[Re(To,{hud:ue(S),ship:ue(v)},null,8,["hud","ship"])]),p("div",jo,[Re(Oo,{visible:n.value,"gamepad-connected":ue(A)},null,8,["visible","gamepad-connected"])]),j[4]||(j[4]=Be('<div class="absolute inset-0 pointer-events-none z-5" data-v-8f16640b><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" data-v-8f16640b><div class="w-6 h-6 border border-cyan-400/40 rounded-full" data-v-8f16640b></div><div class="absolute top-1/2 left-0 w-2 h-px bg-cyan-400/40 -translate-x-full -translate-y-1/2" data-v-8f16640b></div><div class="absolute top-1/2 right-0 w-2 h-px bg-cyan-400/40 translate-x-full -translate-y-1/2" data-v-8f16640b></div><div class="absolute left-1/2 top-0 w-px h-2 bg-cyan-400/40 -translate-y-full -translate-x-1/2" data-v-8f16640b></div><div class="absolute left-1/2 bottom-0 w-px h-2 bg-cyan-400/40 translate-y-full -translate-x-1/2" data-v-8f16640b></div></div></div>',1)),p("div",qo,[ue(A)?(ne(),se("div",Uo,[...j[2]||(j[2]=[p("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor"},[p("path",{d:"M7 6h10a5 5 0 0 1 5 5v2a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5v-2a5 5 0 0 1 5-5zm1 4a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"})],-1),Q(" 手柄已连接 ",-1)])])):de("",!0),p("button",{onClick:j[0]||(j[0]=(...ae)=>ue(z)&&ue(z)(...ae)),class:"px-3 py-1.5 rounded-lg bg-black/50 backdrop-blur-sm border border-cyan-500/30 text-cyan-200/80 text-xs hover:bg-cyan-900/30 hover:border-cyan-400/50 transition-all"}," 视角 (V): "+ce(ue(x)==="first"?"第一人称":ue(x)==="third"?"第三人称":"轨道"),1)])]))}},Xo=kt(Ho,[["__scopeId","data-v-8f16640b"]]),Zo=JSON.parse('{"title":"星际拓荒飞船模拟器","description":"","frontmatter":{"layout":"page","navbar":false,"title":"星际拓荒飞船模拟器"},"headers":[],"relativePath":"workshop/spaceship-simulator.md","filePath":"workshop/spaceship-simulator.md"}'),Ko={name:"workshop/spaceship-simulator.md"},Jo=Object.assign(Ko,{setup(t){return(e,o)=>{const n=Ct("ClientOnly");return ne(),se("div",null,[Re(n,null,{default:Ye(()=>[Re(Xo)]),_:1})])}}});export{Zo as __pageData,Jo as default};
