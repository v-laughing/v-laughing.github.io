import{t as Ft,u as yt,G as U,v as st,l as $,w as ft,m as St,j as xt,V as b,g as V,x as oe,Q as nt,y as ne,p as F,z as ke,f as ht,D as Ot,e as lt,E as Pe,I as It,J as De,q as vt,O as de,K as Ce,N as ze,U as ae,F as Tt,H as Re,X as Ae,Y as Ve,B as se,i as Ge,k as Le,n as ue,a as _e,Z as Ne,s as me,L as Ie,r as pe,_ as he,$ as Te,c as Ee,d as Fe,W as Oe,A as Be,o as We}from"./chunks/three.module.BuDCKSer.js";import{am as Nt,p as Mt,c as it,o as at,j as f,a as j,e as ut,t as dt,N as Qe,b as je,w as fe,T as qe,_ as Ue,v as He,Y as Xe,a4 as ie,G as Bt,k as pt,C as Ke}from"./chunks/framework.DQgBWl2g.js";const Ye=2e-6,ve=933e-6,$e=[{name:"太阳",nameEn:"Sun",color:16755251,emissive:16755251,size:2e3,mass:472e11,orbitRadius:0,orbitSpeed:0,rotationSpeed:5e-5,isStar:!0,description:"星系中心，直径4000米"},{name:"余烬孪星",nameEn:"Ember Twin",color:12868666,emissive:10767402,size:171,mass:115e9,orbitRadius:5e3,orbitSpeed:933e-6,rotationSpeed:833e-6,isTwin:!0,twinSide:1,description:"沙漏双星之一，直径342米，公转速度~280m/s，自转周期~126秒"},{name:"灰烬孪星",nameEn:"Ash Twin",color:15259043,emissive:13153667,size:168,mass:106e9,orbitRadius:5e3,orbitSpeed:933e-6,rotationSpeed:.00116,isTwin:!0,twinSide:-1,description:"沙漏双星之一，直径336米，公转速度~280m/s，自转周期~90秒"},{name:"木炉星",nameEn:"Timber Hearth",color:9089674,emissive:6982250,size:250,mass:361e9,orbitRadius:8593,orbitSpeed:419e-6,rotationSpeed:167e-6,description:"地表半径250米，大气175米，公转速度~216m/s，自转周期~628秒",hasAtmosphere:!0,atmosphereColor:8965375,atmosphereThickness:175},{name:"废墟月亮",nameEn:"Attlerock",color:8947848,emissive:4473924,size:75,mass:1e9,moonOf:"木炉星",moonOrbitRadius:600,moonOrbitSpeed:.002,rotationSpeed:.001,description:"木炉星的卫星，无大气"},{name:"脆壳星",nameEn:"Brittle Hollow",color:8035274,emissive:5929898,size:300,mass:334e9,orbitRadius:11691,orbitSpeed:264e-6,rotationSpeed:333e-6,description:"地表半径300米，大气50米，公转速度~185m/s，自转周期~314秒",hasBlackHole:!0,blackHoleSize:53},{name:"深巨星",nameEn:"Giant's Deep",color:5085818,emissive:4033130,size:500,mass:289e10,orbitRadius:16458,orbitSpeed:158e-6,rotationSpeed:1e-5,description:"地表半径500米，大气450米，公转速度~156m/s，表面重力2g，潮汐锁定",hasAtmosphere:!0,atmosphereColor:6728328,atmosphereThickness:450,surfaceGravity:2},{name:"黑棘星",nameEn:"Dark Bramble",color:3824202,emissive:2771514,size:750,mass:99e10,orbitRadius:2e4,orbitSpeed:118e-6,rotationSpeed:2e-4,description:"地表半径750米，大气250米，公转速度~141m/s",hasAtmosphere:!0,atmosphereColor:13421772,atmosphereThickness:250},{name:"闯入者",nameEn:"The Interloper",color:8969710,emissive:6732748,size:77.5,mass:1e10,orbitA:18e3,orbitB:8e3,orbitSpeed:32e-5,rotationSpeed:3e-4,isComet:!0,description:"椭圆轨道彗星，直径155米，公转速度50~450m/s"},{name:"量子卫星",nameEn:"Quantum Moon",color:12237546,emissive:10132170,size:120,mass:1e10,moonOrbitRadius:1200,moonOrbitSpeed:8e-4,rotationSpeed:.0015,isQuantum:!0,description:"地表半径120米，浓厚银灰色云雾130米"}],te=["灰烬孪星","脆壳星","深巨星","黑棘星","木炉星"];let Et=class{constructor(t=Math.random()){this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(let a=0;a<256;a++)this.p[a]=a;let o,n;for(let a=255;a>0;a--)t=t*16807%2147483647,o=t%(a+1),n=this.p[a],this.p[a]=this.p[o],this.p[o]=n;for(let a=0;a<512;a++)this.perm[a]=this.p[a&255],this.permMod12[a]=this.perm[a]%12;this.grad3=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),this.F2=.5*(Math.sqrt(3)-1),this.G2=(3-Math.sqrt(3))/6,this.F3=1/3,this.G3=1/6}noise2D(t,o){const{perm:n,permMod12:a,grad3:r,F2:c,G2:s}=this,i=(t+o)*c,l=Math.floor(t+i),d=Math.floor(o+i),g=(l+d)*s,M=l-g,k=d-g,p=t-M,h=o-k;let u,v;p>h?(u=1,v=0):(u=0,v=1);const y=p-u+s,w=h-v+s,m=p-1+2*s,S=h-1+2*s,x=l&255,A=d&255;let P=0,z=0,R=0,C=.5-p*p-h*h;if(C>=0){const L=a[x+n[A]]*3;C*=C,P=C*C*(r[L]*p+r[L+1]*h)}let D=.5-y*y-w*w;if(D>=0){const L=a[x+u+n[A+v]]*3;D*=D,z=D*D*(r[L]*y+r[L+1]*w)}let G=.5-m*m-S*S;if(G>=0){const L=a[x+1+n[A+1]]*3;G*=G,R=G*G*(r[L]*m+r[L+1]*S)}return 70*(P+z+R)}noise3D(t,o,n){const{perm:a,permMod12:r,grad3:c,F3:s,G3:i}=this,l=(t+o+n)*s,d=Math.floor(t+l),g=Math.floor(o+l),M=Math.floor(n+l),k=(d+g+M)*i,p=d-k,h=g-k,u=M-k,v=t-p,y=o-h,w=n-u;let m,S,x,A,P,z;v>=y?y>=w?(m=1,S=0,x=0,A=1,P=1,z=0):v>=w?(m=1,S=0,x=0,A=1,P=0,z=1):(m=0,S=0,x=1,A=1,P=0,z=1):y<w?(m=0,S=0,x=1,A=0,P=1,z=1):v<w?(m=0,S=1,x=0,A=0,P=1,z=1):(m=0,S=1,x=0,A=1,P=1,z=0);const R=v-m+i,C=y-S+i,D=w-x+i,G=v-A+2*i,L=y-P+2*i,E=w-z+2*i,N=v-1+3*i,O=y-1+3*i,W=w-1+3*i,B=d&255,I=g&255,T=M&255;let q=0,X=0,Y=0,Z=0,ot=.6-v*v-y*y-w*w;if(ot>=0){const _=r[B+a[I+a[T]]]*3;ot*=ot,q=ot*ot*(c[_]*v+c[_+1]*y+c[_+2]*w)}let J=.6-R*R-C*C-D*D;if(J>=0){const _=r[B+m+a[I+S+a[T+x]]]*3;J*=J,X=J*J*(c[_]*R+c[_+1]*C+c[_+2]*D)}let tt=.6-G*G-L*L-E*E;if(tt>=0){const _=r[B+A+a[I+P+a[T+z]]]*3;tt*=tt,Y=tt*tt*(c[_]*G+c[_+1]*L+c[_+2]*E)}let et=.6-N*N-O*O-W*W;if(et>=0){const _=r[B+1+a[I+1+a[T+1]]]*3;et*=et,Z=et*et*(c[_]*N+c[_+1]*O+c[_+2]*W)}return 32*(q+X+Y+Z)}};const wt=(e,t,o,n,a=4,r=2,c=.5)=>{let s=0,i=1,l=1,d=0;for(let g=0;g<a;g++)s+=e.noise3D(t*l,o*l,n*l)*i,d+=i,i*=c,l*=r;return s/d},we={余烬孪星:{seed:23456,resolution:512,baseColors:[{color:[196,92,58],weight:.5},{color:[180,70,40],weight:.3},{color:[220,120,60],weight:.2}],noiseScale:4,octaves:4,bumpStrength:1.5,hasLava:!0,lavaColor:[255,100,20]},灰烬孪星:{seed:34567,resolution:512,baseColors:[{color:[232,213,163],weight:.4},{color:[200,180,140],weight:.35},{color:[180,160,120],weight:.25}],noiseScale:5,octaves:4,bumpStrength:.8},脆壳星:{seed:45678,resolution:512,baseColors:[{color:[122,155,202],weight:.4},{color:[90,120,170],weight:.3},{color:[60,80,120],weight:.2},{color:[40,50,80],weight:.1}],noiseScale:4,octaves:5,bumpStrength:1.8,hasCracks:!0,crackColor:[20,10,40]},深巨星:{seed:56789,resolution:512,baseColors:[{color:[77,154,122],weight:.5},{color:[60,130,100],weight:.3},{color:[100,180,140],weight:.2}],noiseScale:2,octaves:6,bumpStrength:.4,isGasGiant:!0,bandColors:[[60,140,100],[80,160,120],[50,120,90]]},黑棘星:{seed:67890,resolution:512,baseColors:[{color:[58,90,74],weight:.5},{color:[40,70,55],weight:.3},{color:[30,50,40],weight:.2}],noiseScale:3,octaves:5,bumpStrength:2,hasBrambles:!0},量子卫星:{seed:78901,resolution:256,baseColors:[{color:[186,186,234],weight:.5},{color:[160,160,210],weight:.3},{color:[140,140,190],weight:.2}],noiseScale:4,octaves:3,bumpStrength:.6,isQuantum:!0},闯入者:{seed:89012,resolution:256,baseColors:[{color:[136,221,238],weight:.6},{color:[180,240,250],weight:.3},{color:[100,200,220],weight:.1}],noiseScale:6,octaves:3,bumpStrength:.5,isIcy:!0},废墟月亮:{seed:90123,resolution:256,baseColors:[{color:[136,136,136],weight:.5},{color:[100,100,100],weight:.3},{color:[80,80,80],weight:.2}],noiseScale:5,octaves:4,bumpStrength:1,hasCraters:!0}},Ze=e=>{if(!e||!e.baseColors||e.baseColors.length===0)return null;const{seed:t,resolution:o,baseColors:n,noiseScale:a,octaves:r,hasOcean:c,oceanLevel:s,oceanColor:i,isGasGiant:l,bandColors:d,hasCracks:g,crackColor:M,hasLava:k,lavaColor:p}=e,h=document.createElement("canvas");h.width=o,h.height=o;const u=h.getContext("2d"),v=u.createImageData(o,o),y=v.data,w=new Et(t),m=new Et(t+1e3);for(let x=0;x<o;x++)for(let A=0;A<o;A++){const P=A/o,z=x/o,R=P*Math.PI*2,C=z*Math.PI,D=Math.sin(C)*Math.cos(R),G=Math.sin(C)*Math.sin(R),L=Math.cos(C);let E=wt(w,D*a,G*a,L*a,r);E=(E+1)*.5;let N,O,W;if(l&&d&&d.length>0){const I=wt(m,D*1.5,G*1.5,L*.5,3)*.3,T=(z+I)*d.length*3%d.length,q=Math.floor(T<0?T+d.length:T),X=d[Math.min(q,d.length-1)],Y=E*.3;N=Math.min(255,X[0]+Y*50),O=Math.min(255,X[1]+Y*50),W=Math.min(255,X[2]+Y*30)}else if(c&&i&&E<s){const I=(s-E)/s;N=i[0]*(1-I*.3),O=i[1]*(1-I*.2),W=i[2]*(1+I*.2)}else{let I=0;N=O=W=0,n.forEach((q,X)=>{const Y=wt(m,D*(a+X),G*(a+X),L*(a+X),3),Z=q.weight*(.5+Y*.5);N+=q.color[0]*Z,O+=q.color[1]*Z,W+=q.color[2]*Z,I+=Z}),N/=I,O/=I,W/=I;const T=(E-.5)*40;N=Math.max(0,Math.min(255,N+T)),O=Math.max(0,Math.min(255,O+T)),W=Math.max(0,Math.min(255,W+T))}if(g&&M){const I=wt(m,D*8,G*8,L*8,2);if(Math.abs(I)<.08){const T=1-Math.abs(I)/.08;N=N*(1-T)+M[0]*T,O=O*(1-T)+M[1]*T,W=W*(1-T)+M[2]*T}}if(k&&p){const I=wt(m,D*6,G*6,L*6,3);if(I>.5){const T=(I-.5)*2;N=N*(1-T)+p[0]*T,O=O*(1-T)+p[1]*T,W=W*(1-T)+p[2]*T}}const B=(x*o+A)*4;y[B]=N,y[B+1]=O,y[B+2]=W,y[B+3]=255}u.putImageData(v,0,0);const S=new Ft(h);return S.wrapS=yt,S.wrapT=yt,S},Je=e=>{if(!e)return null;const{seed:t,resolution:o,noiseScale:n,octaves:a,bumpStrength:r,hasCraters:c}=e,s=document.createElement("canvas");s.width=o,s.height=o;const i=s.getContext("2d"),l=i.createImageData(o,o),d=l.data,g=new Et(t),M=new Et(t+500),k=new Float32Array(o*o);for(let u=0;u<o;u++)for(let v=0;v<o;v++){const y=v/o,w=u/o,m=y*Math.PI*2,S=w*Math.PI,x=Math.sin(S)*Math.cos(m),A=Math.sin(S)*Math.sin(m),P=Math.cos(S);let z=wt(g,x*n,A*n,P*n,a);if(c)for(let R=0;R<5;R++){const C=M.noise2D(R*10,0)*.5+.5,D=M.noise2D(0,R*10)*.5+.5,G=.05+M.noise2D(R,R)*.03,L=y-C,E=w-D,N=Math.sqrt(L*L+E*E);if(N<G){const O=(1-N/G)*.5;z-=O*(1-Math.pow(N/G,2))}}k[u*o+v]=z}const p=r*2;for(let u=0;u<o;u++)for(let v=0;v<o;v++){const y=(v-1+o)%o,w=(v+1)%o,m=(u-1+o)%o,S=(u+1)%o,x=k[u*o+y],A=k[u*o+w],P=k[m*o+v],z=k[S*o+v],R=(A-x)*p,C=(z-P)*p;let D=-R,G=-C,L=1;const E=Math.sqrt(D*D+G*G+L*L);D/=E,G/=E,L/=E;const N=(u*o+v)*4;d[N]=Math.floor((D*.5+.5)*255),d[N+1]=Math.floor((G*.5+.5)*255),d[N+2]=Math.floor((L*.5+.5)*255),d[N+3]=255}i.putImageData(l,0,0);const h=new Ft(s);return h.wrapS=yt,h.wrapT=yt,h},to=e=>{const{seed:t,resolution:o,noiseScale:n,hasOcean:a,oceanLevel:r}=e,c=document.createElement("canvas");c.width=o,c.height=o;const s=c.getContext("2d"),i=s.createImageData(o,o),l=i.data,d=new Et(t+2e3);for(let M=0;M<o;M++)for(let k=0;k<o;k++){const p=k/o,h=M/o,u=p*Math.PI*2,v=h*Math.PI,y=Math.sin(v)*Math.cos(u),w=Math.sin(v)*Math.sin(u),m=Math.cos(v);let S=wt(d,y*n,w*n,m*n,4);S=(S+1)*.5;let x;a&&S<(r||.35)?x=.1+Math.random()*.1:x=.4+S*.4+Math.random()*.1;const A=Math.floor(x*255),P=(M*o+k)*4;l[P]=A,l[P+1]=A,l[P+2]=A,l[P+3]=255}s.putImageData(i,0,0);const g=new Ft(c);return g.wrapS=yt,g.wrapT=yt,g},eo=e=>{const t=we[e];if(!t||!t.baseColors)return null;const o=Ze(t),n=Je(t),a=to(t);return!o||!n?null:{diffuseMap:o,normalMap:n,roughnessMap:a}},ee={vertexShader:`
    varying vec3 vWorldNormal;
    varying vec3 vWorldPosition;
    
    void main() {
      vWorldNormal = normalize(modelMatrix * vec4(normal, 0.0)).xyz;
      vec4 worldPos = modelMatrix * vec4(position, 1.0);
      vWorldPosition = worldPos.xyz;
      gl_Position = projectionMatrix * viewMatrix * worldPos;
    }
  `,fragmentShader:`
    uniform vec3 glowColor;
    uniform float intensity;
    uniform float power;
    uniform vec3 sunPosition;
    uniform float planetRadius;
    uniform float atmoRadius;
    
    varying vec3 vWorldNormal;
    varying vec3 vWorldPosition;
    
    void main() {
      vec3 viewDir = normalize(cameraPosition - vWorldPosition);
      vec3 sunDir = normalize(sunPosition - vWorldPosition);
      
      // --- 核心逻辑：基于距离的密度衰减 ---
      float dotNV = dot(vWorldNormal, viewDir);
      
      // d 是视线路径距离星球中心的最近距离
      float d = atmoRadius * sqrt(1.0 - dotNV * dotNV);
      
      // 密度函数：在 atmoRadius 到 planetRadius 之间平滑衰减
      float density = smoothstep(atmoRadius, planetRadius, d);
      density = pow(density, power); 

      // --- 太阳遮蔽与散射 ---
      float sunMix = dot(vWorldNormal, sunDir);
      // 模拟大气的光散，向阳面明亮
      // 修改：背光面不再是完全死黑，保留 0.15 的基础亮度模拟弱散射
      float shadowMask = smoothstep(-0.4, 0.5, sunMix);
      shadowMask = mix(0.15, 1.0, shadowMask);
      
      // 靠近地表的额外浓郁感 (Haze)
      float baseHaze = pow(max(0.0, dotNV), 3.0) * 0.5;
      
      vec3 color = glowColor;
      // 向阳面亮度增强，混合高光色
      vec3 sunGlow = vec3(0.2, 0.3, 0.5) * clamp(sunMix, 0.0, 1.0) * density;
      color += sunGlow;

      // 最终强度受 intensity 统一控制
      float finalAlpha = (density + baseHaze) * shadowMask * intensity;
      
      // 彻底消除球体几何边缘的硬切痕
      finalAlpha *= smoothstep(0.0, 0.1, abs(dotNV));

      gl_FragColor = vec4(color, finalAlpha);
    }
  `},oo=(e,t)=>{const{color:o=8965375,thickness:n=50,intensity:a=1,power:r=2.5}=t,c=new U,s=new st(o),i=e+n,l=new $(i,64,64),d=new ft({vertexShader:ee.vertexShader,fragmentShader:ee.fragmentShader,uniforms:{glowColor:{value:s},intensity:{value:a},power:{value:r},sunPosition:{value:new b(0,0,0)},planetRadius:{value:e},atmoRadius:{value:i}},transparent:!0,blending:xt,side:St,depthWrite:!1}),g=new V(l,d);g.userData.isAtmosphereLayer=!0,c.add(g);const M=no(e,s,a);return c.add(M),c},no=(e,t,o)=>{const n=new $(e+.5,64,64),a=new ft({vertexShader:ee.vertexShader,fragmentShader:`
      uniform vec3 glowColor;
      uniform float intensity;
      uniform vec3 sunPosition;
      
      varying vec3 vWorldNormal;
      varying vec3 vWorldPosition;
      
      void main() {
        vec3 viewDir = normalize(cameraPosition - vWorldPosition);
        vec3 sunDir = normalize(sunPosition - vWorldPosition);
        
        float dotNV = max(0.0, dot(vWorldNormal, viewDir));
        
        // 内部雾气主要负责覆盖在陆地上的那一层薄晕
        float rimIntensity = pow(1.0 - dotNV, 3.0) * 0.6;
        
        float sunMix = dot(vWorldNormal, sunDir);
        // 内部雾气在背光面也保留一点基础可见度
        float shadowMask = smoothstep(-0.3, 0.5, sunMix);
        shadowMask = mix(0.2, 1.0, shadowMask);
        
        vec3 finalColor = glowColor * (1.0 + clamp(sunMix, 0.0, 1.0) * 0.5);
        float alpha = rimIntensity * intensity * shadowMask;
        
        gl_FragColor = vec4(finalColor * alpha, alpha);
      }
    `,uniforms:{glowColor:{value:t},intensity:{value:o},sunPosition:{value:new b(0,0,0)}},transparent:!0,blending:xt,side:oe,depthWrite:!1});return new V(n,a)},so=(e,t)=>{e.children.forEach(o=>{o.material&&o.material.uniforms&&o.material.uniforms.sunPosition&&o.material.uniforms.sunPosition.value.copy(t)})},ao={深巨星:{color:4500104,thickness:200,intensity:1.4,power:2},黑棘星:{color:8952200,thickness:80,intensity:.6,power:3.5}},io=(e,t=6710886)=>{const o=new ze(e,0),n=new F({color:t,roughness:.9,metalness:.1});return new V(o,n)},ro=(e,t,o=4863784,n=2972199)=>{const a=new U,r=new lt(e*.1,e*.15,e,6),c=new F({color:o,roughness:.9}),s=new V(r,c);s.position.y=e/2,a.add(s);const i=new Ce(t,1),l=new F({color:n,roughness:.8}),d=new V(i,l);return d.position.y=e+t*.5,a.add(d),a},co=(e,t,o,n=9139029)=>{const a=new U,r=new It(e,t,o),c=new F({color:n,roughness:.7}),s=new V(r,c);s.position.y=t/2,a.add(s);const i=new vt(e*.8,t*.4,4),l=new F({color:5917242,roughness:.8}),d=new V(i,l);return d.position.y=t+t*.2,d.rotation.y=Math.PI/4,a.add(d),a},lo=(e,t=8943462)=>{const o=new U,n=new It(e*.3,e*.1,e*.3),a=new F({color:t,roughness:.6}),r=new V(n,a);r.position.y=e*.05,o.add(r);const c=new It(e*.15,e*.8,e*.15),s=new V(c,a);s.position.y=e*.5,o.add(s);const i=new de(e*.12,0),l=new F({color:11193599,emissive:4482730,emissiveIntensity:.5,roughness:.3}),d=new V(i,l);return d.position.y=e*.95,o.add(d),o},uo=(e,t=12888194)=>{const o=new U,n=new lt(e*.15,e*.2,e,8),a=new F({color:t,roughness:.7}),r=new V(n,a);r.position.y=e/2,o.add(r);const c=new vt(e*.2,e*.3,8),s=new V(c,a);return s.position.y=e+e*.15,o.add(s),o},mo=(e,t=8969727)=>{const o=new U,n=new de(e,0),a=new F({color:t,emissive:t,emissiveIntensity:.3,roughness:.2,metalness:.8,transparent:!0,opacity:.8}),r=new V(n,a);return r.scale.y=2,o.add(r),o},po=(e,t=2771514)=>{const o=new U,n=new vt(e*.3,e,5),a=new F({color:t,roughness:.8}),r=new V(n,a);r.position.y=e/2,o.add(r);for(let c=0;c<3;c++){const s=new vt(e*.15,e*.5,4),i=new V(s,a);i.position.y=e*.3,i.position.x=Math.cos(c*Math.PI*2/3)*e*.2,i.position.z=Math.sin(c*Math.PI*2/3)*e*.2,i.rotation.z=Math.PI/6*(c%2===0?1:-1),o.add(i)}return o},ho=e=>{const t=new U,o=new $(e,16,16),n=new F({color:11206570,emissive:6750054,emissiveIntensity:.8,roughness:.3}),a=new V(o,n);t.add(a);const r=new $(e*2,16,16),c=new ht({color:4521796,transparent:!0,opacity:.2}),s=new V(r,c);return t.add(s),t},fo=e=>{const t=new U,o=new De(e,0),n=new F({color:13421806,emissive:8947882,emissiveIntensity:.4,roughness:.4,metalness:.6}),a=new V(o,n);return a.rotation.set(Math.random(),Math.random(),Math.random()),t.add(a),t},vo=(e,t=8943462)=>{const o=new U;for(let c=0;c<4;c++){const s=e*(.5+Math.random()*.5),i=new lt(e*.1,e*.12,s,6),l=new F({color:t,roughness:.8}),d=new V(i,l);d.position.x=Math.cos(c*Math.PI/2)*e*.4,d.position.z=Math.sin(c*Math.PI/2)*e*.4,d.position.y=s/2,o.add(d)}const n=new It(e,e*.1,e),a=new F({color:t,roughness:.8}),r=new V(n,a);return r.position.y=e*.05,o.add(r),o},wo=e=>{const t=new U,o=new lt(e,e,e*.1,16),n=new F({color:5592405,roughness:.5,metalness:.3}),a=new V(o,n);a.position.y=e*.05,t.add(a);const r=new ne(e*.8,e*.05,8,32),c=new F({color:16755200,emissive:16746496,emissiveIntensity:.3}),s=new V(r,c);return s.rotation.x=Math.PI/2,s.position.y=e*.12,t.add(s),t},go=e=>{const t=new U,o=new lt(e*.3,e*.4,e*.2,8),n=new F({color:4473924,roughness:.5,metalness:.5}),a=new V(o,n);a.position.y=e*.1,t.add(a);const r=new lt(e*.1,e*.15,e*.8,8),c=new F({color:6710886,roughness:.4,metalness:.6}),s=new V(r,c);return s.position.y=e*.5,s.rotation.x=Math.PI/6,t.add(s),t},yo=e=>{const t=new U,o=new lt(e*.05,e*.05,e,8),n=new F({color:9127187}),a=new V(o,n);a.position.y=e/2,t.add(a);const r=new Pe(e*.4,e*.25),c=new F({color:5085818,side:Ot,emissive:2976330,emissiveIntensity:.2}),s=new V(r,c);return s.position.y=e*.85,s.position.x=e*.2,t.add(s),t},xo=e=>{const t=new U,o=new ne(e,e*.2,8,16),n=new F({color:5592405,roughness:.9}),a=new V(o,n);return a.rotation.x=Math.PI/2,t.add(a),t},bo=e=>{const t=new U,o=new ne(e,e*.1,8,32),n=new F({color:12888194,roughness:.5,metalness:.3}),a=new V(o,n);a.rotation.x=Math.PI/2,a.position.y=e,t.add(a);const r=new ke(e*.85,32),c=new ht({color:4482730,transparent:!0,opacity:.5,side:Ot}),s=new V(r,c);s.rotation.x=Math.PI/2,s.position.y=e,t.add(s);const i=new lt(e*.15,e*.2,e*.3,8),l=new V(i,n);return l.position.y=e*.15,t.add(l),t},ge={余烬孪星:{landmarks:[{type:"ruin",count:3,sizeRange:[8,15],color:10518624},{type:"obelisk",count:5,sizeRange:[6,12]},{type:"rock",count:20,sizeRange:[2,6],color:12868666}]},灰烬孪星:{landmarks:[{type:"tower",count:4,sizeRange:[10,20],color:13943970},{type:"portal",count:2,sizeRange:[5,8]},{type:"rock",count:15,sizeRange:[2,5],color:15259043}]},废墟月亮:{landmarks:[{type:"crater",count:5,sizeRange:[3,8]},{type:"ruin",count:2,sizeRange:[5,10],color:6710886},{type:"rock",count:20,sizeRange:[1,4],color:8947848}]},脆壳星:{landmarks:[{type:"tower",count:3,sizeRange:[12,18],color:9087690},{type:"ruin",count:4,sizeRange:[8,14],color:8035274},{type:"crystal",count:8,sizeRange:[3,7],color:6719692},{type:"rock",count:15,sizeRange:[2,5],color:5929898}]},深巨星:{landmarks:[{type:"islandMarker",count:6,sizeRange:[8,12]},{type:"tower",count:2,sizeRange:[15,25],color:6138506},{type:"rock",count:10,sizeRange:[3,8],color:5085818}]},黑棘星:{landmarks:[{type:"thorn",count:30,sizeRange:[8,20]},{type:"glowingSeed",count:15,sizeRange:[1,3]},{type:"rock",count:10,sizeRange:[3,8],color:3824202}]},闯入者:{landmarks:[{type:"crystal",count:12,sizeRange:[2,6],color:11202303},{type:"rock",count:10,sizeRange:[1,4],color:8969710}]},量子卫星:{landmarks:[{type:"quantumShard",count:20,sizeRange:[2,5]},{type:"obelisk",count:3,sizeRange:[5,10]},{type:"rock",count:10,sizeRange:[1,4],color:12237546}]}},Mo={rock:(e,t)=>io(e,t),tree:e=>ro(e,e*.6),building:e=>co(e,e*1.5,e),obelisk:e=>lo(e),tower:(e,t)=>uo(e,t),crystal:(e,t)=>mo(e,t),thorn:e=>po(e),glowingSeed:e=>ho(e),quantumShard:e=>fo(e),ruin:(e,t)=>vo(e,t),launchPad:e=>wo(e),telescope:e=>go(e),islandMarker:e=>yo(e),crater:e=>xo(e),portal:e=>bo(e)},So=(e,t,o)=>{const n=ge[e];if(!n)return;let a=0;for(let c=0;c<e.length;c++)a+=e.charCodeAt(c);const r=()=>{const c=Math.sin(a++)*1e4;return c-Math.floor(c)};n.landmarks.forEach(c=>{const{type:s,count:i,sizeRange:l,color:d}=c,g=Mo[s];if(g)for(let M=0;M<i;M++){const k=l[0]+r()*(l[1]-l[0]),p=g(k,d),h=r()*Math.PI*2,u=Math.acos(2*r()-1),v=Math.sin(u)*Math.cos(h),y=Math.sin(u)*Math.sin(h),w=Math.cos(u),m=new b(v,y,w).multiplyScalar(t);p.position.copy(m);const S=m.clone().normalize(),x=new b(0,1,0),A=new nt().setFromUnitVectors(x,S);p.quaternion.copy(A),p.rotateY(r()*Math.PI*2),o.add(p)}})},Yt={uniforms:{time:{value:0},colorBright:{value:new st(16774579)},colorDark:{value:new st(16729344)},fresnelColor:{value:new st(16763904)}},vertexShader:`
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vViewPosition;

    void main() {
      vUv = uv;
      vNormal = normalize(normalMatrix * normal);
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      vViewPosition = -mvPosition.xyz;
      gl_Position = projectionMatrix * mvPosition;
    }
  `,fragmentShader:`
    uniform float time;
    uniform vec3 colorBright;
    uniform vec3 colorDark;
    uniform vec3 fresnelColor;
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vViewPosition;

    // 经典噪声函数
    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
    vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }

    float snoise(vec2 v) {
      const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
      vec2 i  = floor(v + dot(v, C.yy));
      vec2 x0 = v -   i + dot(i, C.xx);
      vec2 i1;
      i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
      vec4 x12 = x0.xyxy + C.xxzz;
      x12.xy -= i1;
      i = mod289(i);
      vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
      vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
      m = m*m; m = m*m;
      vec3 x = 2.0 * fract(p * C.www) - 1.0;
      vec3 h = abs(x) - 0.5;
      vec3 ox = floor(x + 0.5);
      vec3 a0 = x - ox;
      m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
      vec3 g;
      g.x  = a0.x  * x0.x  + h.x  * x0.y;
      g.yz = a0.yz * x12.xz + h.yz * x12.yw;
      return 130.0 * dot(m, g);
    }

    void main() {
      // 多层噪声叠加形成动态表面
      float noise = snoise(vUv * 4.0 + time * 0.05);
      noise += 0.5 * snoise(vUv * 8.0 - time * 0.07);
      noise = noise * 0.5 + 0.5;

      // 混合基础颜色
      vec3 baseColor = mix(colorDark, colorBright, noise);

      // 菲涅尔效果：让球体中心亮，边缘带有强烈的辐射感
      vec3 viewDir = normalize(vViewPosition);
      float fresnel = pow(1.0 - max(0.0, dot(vNormal, viewDir)), 1.5);
      
      // 增加曝光感：在中心区域叠加极高亮度
      float centerBrightness = pow(max(0.0, dot(vNormal, viewDir)), 2.0);
      vec3 finalColor = baseColor * (1.0 + centerBrightness * 0.5) + fresnelColor * fresnel * 2.5;

      gl_FragColor = vec4(finalColor, 1.0);
    }
  `},$t={uniforms:{time:{value:0},glowColor:{value:new st(16746496)}},vertexShader:`
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    varying vec3 vPosition;

    void main() {
      vPosition = position;
      vNormal = normalize(normalMatrix * normal);
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      vViewPosition = -mvPosition.xyz;
      gl_Position = projectionMatrix * mvPosition;
    }
  `,fragmentShader:`
    uniform float time;
    uniform vec3 glowColor;
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    varying vec3 vPosition;

    void main() {
      vec3 viewDir = normalize(vViewPosition);
      
      float vDotN = clamp(abs(dot(vNormal, viewDir)), 0.0, 1.0);
      
      float edgeSoftness = smoothstep(0.0, 0.7, vDotN);
      float rim = 1.0 - vDotN;
      float intensity = pow(rim, 1.35) * pow(edgeSoftness, 2.4);
      
      float pulse = 0.92 + 0.08 * sin(time * 1.7);
      float colorStrength = pow(intensity, 1.05);
      
      gl_FragColor = vec4(glowColor * pulse * 2.2 * colorStrength, intensity);
    }
  `};function ko(e){const t=new U,o=new $(e,128,128),n=new ft({uniforms:ae.clone(Yt.uniforms),vertexShader:Yt.vertexShader,fragmentShader:Yt.fragmentShader}),a=new V(o,n);a.name="SunSurface",t.add(a);const r=new $(e*1.85,64,64),c=new ft({uniforms:ae.clone($t.uniforms),vertexShader:$t.vertexShader,fragmentShader:$t.fragmentShader,side:St,blending:xt,transparent:!0,depthWrite:!1}),s=new V(r,c);s.name="SunHalo",t.add(s);const i=new $(e*1.05,64,64),l=new ft({vertexShader:`
      varying vec3 vNormal;
      varying vec3 vViewPosition;
      void main() {
        vNormal = normalize(normalMatrix * normal);
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        vViewPosition = -mvPosition.xyz;
        gl_Position = projectionMatrix * mvPosition;
      }
    `,fragmentShader:`
      uniform vec3 color;
      varying vec3 vNormal;
      varying vec3 vViewPosition;
      void main() {
        vec3 viewDir = normalize(vViewPosition);
        float vDotN = max(0.0, dot(viewDir, vNormal));
        float rim = 1.0 - vDotN;
        float alpha = pow(rim, 5.0) * pow(vDotN, 0.85) * 1.8;
        gl_FragColor = vec4(color * alpha, alpha);
      }
    `,uniforms:{color:{value:new st(16773290)}},transparent:!0,blending:xt,side:oe,depthWrite:!1}),d=new V(i,l);return t.add(d),t}function Po(e,t){e.children.forEach(o=>{o.material&&o.material.uniforms&&o.material.uniforms.time&&(o.material.uniforms.time.value=t),o.name==="SunSurface"&&(o.rotation.y+=1e-4)})}class Do{constructor(t=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let o=0;o<256;o++)this.p[o]=Math.floor(t.random()*256);this.perm=[];for(let o=0;o<512;o++)this.perm[o]=this.p[o&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}noise(t,o){let n,a,r;const c=.5*(Math.sqrt(3)-1),s=(t+o)*c,i=Math.floor(t+s),l=Math.floor(o+s),d=(3-Math.sqrt(3))/6,g=(i+l)*d,M=i-g,k=l-g,p=t-M,h=o-k;let u,v;p>h?(u=1,v=0):(u=0,v=1);const y=p-u+d,w=h-v+d,m=p-1+2*d,S=h-1+2*d,x=i&255,A=l&255,P=this.perm[x+this.perm[A]]%12,z=this.perm[x+u+this.perm[A+v]]%12,R=this.perm[x+1+this.perm[A+1]]%12;let C=.5-p*p-h*h;C<0?n=0:(C*=C,n=C*C*this._dot(this.grad3[P],p,h));let D=.5-y*y-w*w;D<0?a=0:(D*=D,a=D*D*this._dot(this.grad3[z],y,w));let G=.5-m*m-S*S;return G<0?r=0:(G*=G,r=G*G*this._dot(this.grad3[R],m,S)),70*(n+a+r)}noise3d(t,o,n){let a,r,c,s;const l=(t+o+n)*.3333333333333333,d=Math.floor(t+l),g=Math.floor(o+l),M=Math.floor(n+l),k=1/6,p=(d+g+M)*k,h=d-p,u=g-p,v=M-p,y=t-h,w=o-u,m=n-v;let S,x,A,P,z,R;y>=w?w>=m?(S=1,x=0,A=0,P=1,z=1,R=0):y>=m?(S=1,x=0,A=0,P=1,z=0,R=1):(S=0,x=0,A=1,P=1,z=0,R=1):w<m?(S=0,x=0,A=1,P=0,z=1,R=1):y<m?(S=0,x=1,A=0,P=0,z=1,R=1):(S=0,x=1,A=0,P=1,z=1,R=0);const C=y-S+k,D=w-x+k,G=m-A+k,L=y-P+2*k,E=w-z+2*k,N=m-R+2*k,O=y-1+3*k,W=w-1+3*k,B=m-1+3*k,I=d&255,T=g&255,q=M&255,X=this.perm[I+this.perm[T+this.perm[q]]]%12,Y=this.perm[I+S+this.perm[T+x+this.perm[q+A]]]%12,Z=this.perm[I+P+this.perm[T+z+this.perm[q+R]]]%12,ot=this.perm[I+1+this.perm[T+1+this.perm[q+1]]]%12;let J=.6-y*y-w*w-m*m;J<0?a=0:(J*=J,a=J*J*this._dot3(this.grad3[X],y,w,m));let tt=.6-C*C-D*D-G*G;tt<0?r=0:(tt*=tt,r=tt*tt*this._dot3(this.grad3[Y],C,D,G));let et=.6-L*L-E*E-N*N;et<0?c=0:(et*=et,c=et*et*this._dot3(this.grad3[Z],L,E,N));let _=.6-O*O-W*W-B*B;return _<0?s=0:(_*=_,s=_*_*this._dot3(this.grad3[ot],O,W,B)),32*(a+r+c+s)}noise4d(t,o,n,a){const r=this.grad4,c=this.simplex,s=this.perm,i=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;let d,g,M,k,p;const h=(t+o+n+a)*i,u=Math.floor(t+h),v=Math.floor(o+h),y=Math.floor(n+h),w=Math.floor(a+h),m=(u+v+y+w)*l,S=u-m,x=v-m,A=y-m,P=w-m,z=t-S,R=o-x,C=n-A,D=a-P,G=z>R?32:0,L=z>C?16:0,E=R>C?8:0,N=z>D?4:0,O=R>D?2:0,W=C>D?1:0,B=G+L+E+N+O+W,I=c[B][0]>=3?1:0,T=c[B][1]>=3?1:0,q=c[B][2]>=3?1:0,X=c[B][3]>=3?1:0,Y=c[B][0]>=2?1:0,Z=c[B][1]>=2?1:0,ot=c[B][2]>=2?1:0,J=c[B][3]>=2?1:0,tt=c[B][0]>=1?1:0,et=c[B][1]>=1?1:0,_=c[B][2]>=1?1:0,K=c[B][3]>=1?1:0,rt=z-I+l,H=R-T+l,Q=C-q+l,ct=D-X+l,mt=z-Y+2*l,bt=R-Z+2*l,kt=C-ot+2*l,Pt=D-J+2*l,Wt=z-tt+3*l,Qt=R-et+3*l,jt=C-_+3*l,qt=D-K+3*l,Ut=z-1+4*l,Ht=R-1+4*l,Xt=C-1+4*l,Kt=D-1+4*l,Dt=u&255,Ct=v&255,zt=y&255,Rt=w&255,ye=s[Dt+s[Ct+s[zt+s[Rt]]]]%32,xe=s[Dt+I+s[Ct+T+s[zt+q+s[Rt+X]]]]%32,be=s[Dt+Y+s[Ct+Z+s[zt+ot+s[Rt+J]]]]%32,Me=s[Dt+tt+s[Ct+et+s[zt+_+s[Rt+K]]]]%32,Se=s[Dt+1+s[Ct+1+s[zt+1+s[Rt+1]]]]%32;let At=.6-z*z-R*R-C*C-D*D;At<0?d=0:(At*=At,d=At*At*this._dot4(r[ye],z,R,C,D));let Vt=.6-rt*rt-H*H-Q*Q-ct*ct;Vt<0?g=0:(Vt*=Vt,g=Vt*Vt*this._dot4(r[xe],rt,H,Q,ct));let Gt=.6-mt*mt-bt*bt-kt*kt-Pt*Pt;Gt<0?M=0:(Gt*=Gt,M=Gt*Gt*this._dot4(r[be],mt,bt,kt,Pt));let Lt=.6-Wt*Wt-Qt*Qt-jt*jt-qt*qt;Lt<0?k=0:(Lt*=Lt,k=Lt*Lt*this._dot4(r[Me],Wt,Qt,jt,qt));let _t=.6-Ut*Ut-Ht*Ht-Xt*Xt-Kt*Kt;return _t<0?p=0:(_t*=_t,p=_t*_t*this._dot4(r[Se],Ut,Ht,Xt,Kt)),27*(d+g+M+k+p)}_dot(t,o,n){return t[0]*o+t[1]*n}_dot3(t,o,n,a){return t[0]*o+t[1]*n+t[2]*a}_dot4(t,o,n,a,r){return t[0]*o+t[1]*n+t[2]*a+t[3]*r}}const Co=e=>{let t=e>>>0;return{random:()=>(t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>0)/4294967296)}};class zo extends U{constructor(){super(),this.radius=250,this.maxHeight=10,this.segments=256,this.simplex=new Do(Co(12345)),this.colors={grass:new st(3824170),rock:new st(5921360),snow:new st(15658734),crater:new st(2763301),trunk:new st(4008735),leaves:new st(1717018)},this.init()}init(){this.createTerrain(),this.createAtmosphere(),this.createClouds(),this.createLocalLights()}getNoise(t,o,n=4){let a=0,r=1,c=o;for(let s=0;s<n;s++)a+=this.simplex.noise3d(t.x*c,t.y*c,t.z*c)*r,r*=.5,c*=2;return a}createTerrain(){const t=new $(this.radius,this.segments,this.segments);t.deleteAttribute("uv");const o=t.attributes.position,n=new Float32Array(o.count*3),a=[],r=new b;for(let s=0;s<o.count;s++){r.fromBufferAttribute(o,s);let i=this.getNoise(r,.005,3);const l=this.simplex.noise3d(r.x*.015,r.y*.015,r.z*.015);let d=0;l>.6&&(d=Math.pow((l-.6)*3,2)*-4);const g=i*this.maxHeight+d,M=r.clone().normalize().multiplyScalar(this.radius+g);o.setXYZ(s,M.x,M.y,M.z);let k=this.colors.grass.clone();g>this.maxHeight*.7?k.lerp(this.colors.snow,(g-this.maxHeight*.7)/(this.maxHeight*.3)):g<-1?k.lerp(this.colors.rock,.8):d<-1?k=this.colors.crater.clone():k.multiplyScalar(.8+Math.random()*.4),n[s*3]=k.r,n[s*3+1]=k.g,n[s*3+2]=k.b,g>0&&g<3&&Math.random()>.998&&a.push(M)}t.setAttribute("color",new Tt(n,3)),t.computeVertexNormals();const c=new F({vertexColors:!0,roughness:.95,metalness:.05,emissive:new st(329733),emissiveIntensity:.1});this.planet=new V(t,c),this.planet.layers.enable(1),this.add(this.planet),this.createTrees(a)}createTrees(t){this.treeGroup=new U;const o=new lt(.5,.8,4,6),n=new F({color:this.colors.trunk}),a=new vt(2.5,8,8),r=new F({color:this.colors.leaves});t.forEach(c=>{const s=new U,i=new V(o,n);i.position.y=2,s.add(i);const l=new V(a,r);l.position.y=6,s.add(l),s.quaternion.setFromUnitVectors(new b(0,1,0),c.clone().normalize()),s.position.copy(c),s.scale.setScalar(.5+Math.random()*1.5),s.traverse(d=>{d.isMesh&&d.layers.enable(1)}),this.treeGroup.add(s)}),this.planet.add(this.treeGroup)}createAtmosphere(){const t=new $(this.radius*1.2,64,64);this.atmoMat=new ft({vertexShader:`
        varying vec3 vWorldNormal;
        varying vec3 vWorldPosition;
        void main() {
          vWorldNormal = normalize(modelMatrix * vec4(normal, 0.0)).xyz;
          vec4 worldPos = modelMatrix * vec4(position, 1.0);
          vWorldPosition = worldPos.xyz;
          gl_Position = projectionMatrix * viewMatrix * worldPos;
        }
      `,fragmentShader:`
        uniform vec3 glowColor;
        uniform float intensity;
        uniform float power;
        uniform vec3 sunPosition;
        uniform float planetRadius;
        uniform float atmoRadius;
        varying vec3 vWorldNormal;
        varying vec3 vWorldPosition;
        void main() {
          vec3 viewDir = normalize(cameraPosition - vWorldPosition);
          vec3 sunDir = normalize(sunPosition - vWorldPosition);
          float dotNV = dot(vWorldNormal, viewDir);
          float d = atmoRadius * sqrt(1.0 - dotNV * dotNV);
          float density = smoothstep(atmoRadius, planetRadius, d);
          density = pow(density, power);
          float sunMix = dot(vWorldNormal, sunDir);
          float shadowMask = smoothstep(-0.4, 0.5, sunMix);
          shadowMask = mix(0.15, 1.0, shadowMask);
          float baseHaze = pow(max(0.0, dotNV), 3.0) * 0.5;
          vec3 color = glowColor;
          // 让大气整体更“浅蓝”、更接近白（减少饱和度）
          vec3 sunGlow = vec3(0.35, 0.52, 0.75) * clamp(sunMix, 0.0, 1.0) * density;
          color += sunGlow;
          float finalAlpha = (density + baseHaze) * shadowMask * intensity;
          finalAlpha *= smoothstep(0.0, 0.1, abs(dotNV));
          gl_FragColor = vec4(color, finalAlpha);
        }
      `,uniforms:{glowColor:{value:new st(12577279)},intensity:{value:.7},power:{value:2.6},sunPosition:{value:new b(0,0,0)},planetRadius:{value:this.radius},atmoRadius:{value:this.radius*1.2}},side:St,blending:xt,transparent:!0,depthWrite:!1});const o=new V(t,this.atmoMat);o.layers.enable(1),this.add(o);const n=new $(this.radius+10,64,64),a=new F({color:12577279,transparent:!0,opacity:.08,side:St}),r=new V(n,a);r.layers.enable(1),this.add(r)}createClouds(){const t=new $(this.radius+25,64,64),o=new F({color:16777215,transparent:!0,opacity:.15,depthWrite:!1,alphaMap:this.createCloudTexture()});this.clouds=new V(t,o),this.clouds.layers.enable(1),this.add(this.clouds)}createCloudTexture(){const t=document.createElement("canvas");t.width=512,t.height=512;const o=t.getContext("2d"),n=o.createImageData(512,512);for(let r=0;r<n.data.length;r+=4){const c=r/4%512,s=Math.floor(r/4/512),i=this.simplex.noise3d(c*.01,s*.01,0)*.5+.5,l=i>.8?(i-.8)*5*255:0;n.data[r]=n.data[r+1]=n.data[r+2]=255,n.data[r+3]=Math.min(255,l)}o.putImageData(n,0,0);const a=new Ft(t);return a.wrapS=a.wrapT=yt,a}createLocalLights(){this.skyLight=new Re(12315903,4008735,.8),this.skyLight.layers.enable(1),this.add(this.skyLight);const t=new Ae;this.add(t),this.sunLight=new Ve(16777215,4.5),this.sunLight.layers.enable(1),this.sunLight.target=t,this.add(this.sunLight)}update(t){const o=new b;this.planet.getWorldPosition(o);const a=new b().subVectors(t,o).normalize().clone().multiplyScalar(2e3);this.sunLight.position.copy(a),this.atmoMat&&this.atmoMat.uniforms.sunPosition.value.copy(t),this.clouds&&(this.clouds.rotation.y+=5e-5*60,this.clouds.rotation.x+=1e-5*60)}}const Ro=()=>{const e=new zo;return{root:e,planet:e.planet,atmosphereGroup:e,update:t=>e.update(t)}},Ao=()=>{const e=document.createElement("canvas");e.width=64,e.height=64;const t=e.getContext("2d"),o=t.createRadialGradient(32,32,0,32,32,32);return o.addColorStop(0,"rgba(255, 255, 255, 1)"),o.addColorStop(.15,"rgba(255, 255, 255, 1)"),o.addColorStop(.3,"rgba(255, 255, 255, 0.8)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.4)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=o,t.fillRect(0,0,64,64),new Ft(e)},Vo=()=>{const e=new se,t=[],o=[];for(let a=0;a<15e3;a++){const r=4e4+Math.random()*5e4,c=Math.random()*Math.PI*2,s=Math.acos(2*Math.random()-1);t.push(r*Math.sin(s)*Math.cos(c),r*Math.sin(s)*Math.sin(c),r*Math.cos(s));const i=Math.random();i<.1?o.push(1,.9,.7):i<.2?o.push(.85,.95,1):o.push(1,1,1)}e.setAttribute("position",new Tt(t,3)),e.setAttribute("color",new Tt(o,3));const n=new Ge({size:2.5,map:Ao(),vertexColors:!0,transparent:!0,opacity:1,sizeAttenuation:!0,depthWrite:!1,blending:xt});return new Le(e,n)},Go=e=>{const t=new U,o=e.name==="木炉星"?0:Math.random()*Math.PI*2;t.userData={...e,angle:o};const n=e.isStar||we[e.name]?64:32,a=new $(e.size,n,n);let r,c=null;if(e.isStar){c=ko(e.size),t.add(c),r=c.getObjectByName("SunSurface");const s=new ue(16768392,3,5e4);t.add(s)}else if(e.name==="木炉星"){const s=Ro();t.add(s.root),r=s.planet,t.userData.atmosphere=s.atmosphereGroup,t.userData.updateModel=s.update}else{let s;const i=eo(e.name);i?s=new F({map:i.diffuseMap,normalMap:i.normalMap,normalScale:new _e(1.5,1.5),roughnessMap:i.roughnessMap,roughness:.7,metalness:.1,emissive:new st(e.emissive),emissiveIntensity:.15}):s=new F({color:e.color,emissive:e.emissive,emissiveIntensity:.4,roughness:.6,metalness:.2}),r=new V(a,s),t.add(r)}if(t.userData.mesh=r,!e.isStar){const s=new U;ge[e.name]&&So(e.name,e.size,s),r.add(s)}if(e.hasAtmosphere&&e.atmosphereThickness&&e.name!=="木炉星"){const s=ao[e.name]||{color:e.atmosphereColor||16777215,thickness:e.atmosphereThickness,intensity:.6,power:2.5},i=oo(e.size,s);i.userData.isAtmosphere=!0,t.add(i),t.userData.atmosphere=i}if(e.hasBlackHole){const s=e.blackHoleSize||e.size*.15,i=new $(s,32,32),l=new ht({color:0}),d=new V(i,l);d.position.set(0,0,0),t.add(d);const g=new Ne(s*1.2,s*2.5,64),M=new ft({vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying vec2 vUv;
        void main() {
          float dist = length(vUv - 0.5) * 2.0;
          float alpha = smoothstep(0.0, 0.5, dist) * smoothstep(1.0, 0.6, dist);
          vec3 color = mix(vec3(0.5, 0.3, 1.0), vec3(0.2, 0.1, 0.5), dist);
          gl_FragColor = vec4(color, alpha * 0.7);
        }
      `,transparent:!0,side:Ot,depthWrite:!1,blending:xt}),k=new V(g,M);k.rotation.x=Math.PI/2,t.add(k);const p=new $(s*1.8,32,32),h=new ht({color:4465322,transparent:!0,opacity:.25,side:St});t.add(new V(p,h))}if(e.isComet){const s=new vt(e.size*.6,e.size*5,8),i=new ht({color:6741503,transparent:!0,opacity:.3,side:Ot}),l=new V(s,i);l.rotation.x=Math.PI/2,l.position.z=e.size*2.5,t.add(l),t.userData.tail=l}if(e.isQuantum){const s=e.size+(e.atmosphereThickness||130),i=new $(s,48,48),l=new ft({vertexShader:`
        varying vec3 vNormal;
        varying vec3 vViewPosition;
        void main() {
          vNormal = normalize(normalMatrix * normal);
          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
          vViewPosition = -mvPosition.xyz;
          gl_Position = projectionMatrix * mvPosition;
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying vec3 vViewPosition;
        void main() {
          vec3 viewDir = normalize(vViewPosition);
          float vDotN = max(0.0, abs(dot(viewDir, vNormal)));
          
          // 增加 vDotN 因子，使雾气向边缘自然淡出
          float rim = 1.0 - vDotN;
          float alpha = (0.85 + rim * 0.15) * vDotN * 1.5;
          
          vec3 fogColor = vec3(0.35, 0.35, 0.4);
          gl_FragColor = vec4(fogColor, alpha);
        }
      `,transparent:!0,side:oe,depthWrite:!1}),d=new V(i,l);t.add(d);const g=new $(e.size*1.05,32,32),M=new ht({color:4473941,transparent:!0,opacity:.95});t.add(new V(g,M));const k=new $(s*1.08,32,32),p=new ht({color:5592422,transparent:!0,opacity:.1,side:St});t.add(new V(k,p))}return{group:t,sunCoronaGroup:c}},re=(e,t=!1)=>{const n=new se,a=[];for(let s=0;s<=128;s++){const i=s/128*Math.PI*2;a.push(Math.cos(i)*e,0,Math.sin(i)*e)}n.setAttribute("position",new Tt(a,3));const r=t?new me({color:4478310,transparent:!0,opacity:.3,dashSize:2,gapSize:1}):new Ie({color:3359829,transparent:!0,opacity:.25}),c=new pe(n,r);return t&&c.computeLineDistances(),c},Lo=(e,t)=>{const n=new se,a=[],r=Math.sqrt(e*e-t*t);for(let i=0;i<=128;i++){const l=i/128*Math.PI*2;a.push(Math.cos(l)*e-r,0,Math.sin(l)*t)}n.setAttribute("position",new Tt(a,3));const c=new me({color:4491434,transparent:!0,opacity:.35,dashSize:1.5,gapSize:1}),s=new pe(n,c);return s.computeLineDistances(),s},_o=e=>{const t=new U,o=new vt(1.5,6,8),n=new F({color:13404228,emissive:4465169,emissiveIntensity:.3,roughness:.4,metalness:.6}),a=new V(o,n);a.rotation.x=Math.PI/2,t.add(a);const r=new It(8,.3,2),c=new F({color:8939059,roughness:.5,metalness:.4}),s=new V(r,c);s.position.z=1,t.add(s);const i=new $(1,16,16,0,Math.PI*2,0,Math.PI/2),l=new F({color:8965375,transparent:!0,opacity:.7,roughness:.1,metalness:.8}),d=new V(i,l);d.rotation.x=-Math.PI/2,d.position.z=-1.5,t.add(d);const g=new lt(.8,1,1.5,8),M=new F({color:4473924,roughness:.3,metalness:.8}),k=new V(g,M);k.rotation.x=Math.PI/2,k.position.z=3.5,t.add(k);const p=(v,y,w=1)=>{const m=new vt(.5*w,2*w,8),S=new ht({color:16737792,transparent:!0,opacity:0,depthTest:!1}),x=new V(m,S);return x.position.copy(v),x.rotation.set(y.x,y.y,y.z),x.renderOrder=999,t.add(x),x},h={back:p(new b(0,0,5),new b(-Math.PI/2,0,0),1.2),front:p(new b(0,0,-4),new b(Math.PI/2,0,0),.8),left:p(new b(2,0,0),new b(0,0,Math.PI/2),.6),right:p(new b(-2,0,0),new b(0,0,-Math.PI/2),.6),bottom:p(new b(0,2,1),new b(0,0,0),.6),top:p(new b(0,-2,1),new b(Math.PI,0,0),.6)};t.userData.thrusters=h;const u=new ue(16777130,.5,50);return u.position.set(0,0,-2.5),t.add(u),t.position.copy(e),t},ce=(e,t)=>{const o=e==null?void 0:e.userData.thrusters;if(!o)return;const n=.8+Math.random()*.4;o.back.material.opacity=t.forward?.9:0,t.forward&&(o.back.scale.y=n),o.front.material.opacity=t.backward?.8:0,t.backward&&(o.front.scale.y=n),o.left.material.opacity=t.left?.7:0,t.left&&(o.left.scale.y=n),o.right.material.opacity=t.right?.7:0,t.right&&(o.right.scale.y=n),o.top.material.opacity=t.up?.7:0,t.up&&(o.top.scale.y=n),o.bottom.material.opacity=t.down?.7:0,t.down&&(o.bottom.scale.y=n)},No=(e,t)=>{const o=new b;return t.forEach(n=>{const a=n.userData;if(!a.mass)return;const r=new b().subVectors(n.position,e),c=r.length();if(c<a.size)return;const s=Ye*a.mass/(c*c);r.normalize().multiplyScalar(s),o.add(r)}),o},Zt=(e,t)=>{let o=null,n=1/0;return t.forEach(a=>{const r=a.userData;if(r.isStar)return;const c=e.distanceTo(a.position)-r.size;c<n&&(n=c,o=a)}),{body:o,distance:n}},gt=(e,t,o)=>{const n=e.userData;if(n.isStar)return new b(0,0,0);const a=e.position.clone(),r=.016;let c,s;if(n.isComet&&n.orbitA&&n.orbitB){const i=Math.sqrt(n.orbitA*n.orbitA-n.orbitB*n.orbitB),l=n.angle+n.orbitSpeed*r*60;c=Math.cos(l)*n.orbitA-i,s=Math.sin(l)*n.orbitB}else if(n.isTwin){const i=o+ve*r*60,l=Math.cos(i)*n.orbitRadius,d=Math.sin(i)*n.orbitRadius,g=400,M=i*10;c=l+Math.cos(M)*g*n.twinSide,s=d+Math.sin(M)*g*n.twinSide}else if(n.moonOf){const i=t.find(l=>l.userData.name===n.moonOf);if(i){const l=gt(i,t,o),d=(n.moonAngle||0)+n.moonOrbitSpeed*r*60,g=-Math.sin(d)*n.moonOrbitRadius*n.moonOrbitSpeed*60,M=Math.cos(d)*n.moonOrbitRadius*n.moonOrbitSpeed*60;return new b(l.x+g,0,l.z+M)}return new b(0,0,0)}else if(n.orbitRadius){const i=n.angle+n.orbitSpeed*r*60;c=Math.cos(i)*n.orbitRadius,s=Math.sin(i)*n.orbitRadius}else return new b(0,0,0);return new b((c-a.x)/r,0,(s-a.z)/r)},le=(e,t,o,n,a)=>{let r=o+ve*e*60,c=a;return t.forEach(s=>{const i=s.userData;if(i.isQuantum){const l=te[n],d=t.find(g=>g.userData.name===l);d&&(c+=i.moonOrbitSpeed*e*60,s.position.x=d.position.x+Math.cos(c)*i.moonOrbitRadius,s.position.y=Math.sin(c)*i.moonOrbitRadius*.3,s.position.z=d.position.z+Math.sin(c)*i.moonOrbitRadius);return}if(i.moonOf){const l=t.find(d=>d.userData.name===i.moonOf);l&&(i.moonAngle=(i.moonAngle||0)+i.moonOrbitSpeed*e*60,s.position.x=l.position.x+Math.cos(i.moonAngle)*i.moonOrbitRadius,s.position.y=Math.sin(i.moonAngle)*i.moonOrbitRadius*.2,s.position.z=l.position.z+Math.sin(i.moonAngle)*i.moonOrbitRadius);return}if(i.orbitRadius>0||i.isComet)if(i.angle+=i.orbitSpeed*e*60,i.isComet&&i.orbitA&&i.orbitB){const l=Math.sqrt(i.orbitA*i.orbitA-i.orbitB*i.orbitB);if(s.position.x=Math.cos(i.angle)*i.orbitA-l,s.position.z=Math.sin(i.angle)*i.orbitB,i.tail){const d=i.orbitA*Math.sin(i.angle),g=-i.orbitB*Math.cos(i.angle);s.rotation.y=Math.atan2(d,g)}}else if(i.isTwin){const l=Math.cos(r)*i.orbitRadius,d=Math.sin(r)*i.orbitRadius,g=400,M=r*10;s.position.x=l+Math.cos(M)*g*i.twinSide,s.position.z=d+Math.sin(M)*g*i.twinSide}else s.position.x=Math.cos(i.angle)*i.orbitRadius,s.position.z=Math.sin(i.angle)*i.orbitRadius;i.mesh&&i.rotationSpeed&&(i.mesh.rotation.y+=i.rotationSpeed*e*60)}),{twinSystemAngle:r,quantumAngle:c}};let Jt=0;const Io=e=>{const t=Nt({position:new b().copy(e),velocity:new b(0,0,0),rotation:new he(0,0,0),thrust:25,rotationSpeed:1.5,maxSpeed:500,fuel:100,isLanded:!1,landedOn:null,landedLocalDir:null,landedLocalQuaternion:new nt,isMatchingVelocity:!1,targetVelocity:new b(0,0,0),matchingTarget:null,initialVelocityDiff:0}),o=Nt({forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rollLeft:!1,rollRight:!1,pitchUp:!1,pitchDown:!1,boost:!1,matchVelocity:!1}),n=Nt({speed:0,altitude:0,nearestBody:null,nearestDistance:0,isThrusting:!1,isMatchingVelocity:!1,matchingProgress:0}),a=Mt("first");let r=null;const c=p=>{r=p},s=(p,h)=>{if(t.isMatchingVelocity){t.isMatchingVelocity=!1,t.matchingTarget=null,t.initialVelocityDiff=0;return}const u=Zt(t.position,p);u.body&&(t.isMatchingVelocity=!0,t.matchingTarget=u.body,t.targetVelocity.copy(gt(u.body,p,h)),t.initialVelocityDiff=new b().subVectors(t.targetVelocity,t.velocity).length())},i=(p,h,u)=>{if(!t.isMatchingVelocity||!t.matchingTarget)return;const v=gt(t.matchingTarget,h,u);t.targetVelocity.copy(v);const y=new b().subVectors(t.targetVelocity,t.velocity),w=y.length();if(w<.5){t.velocity.copy(t.targetVelocity),t.isMatchingVelocity=!1,t.matchingTarget=null;return}const S=25*p;if(w<=S)t.velocity.copy(t.targetVelocity);else{const x=y.normalize().multiplyScalar(S);t.velocity.add(x)}n.matchingProgress=(1-w/t.initialVelocityDiff)*100},l=(p,h)=>{if(!t.isLanded||!t.landedOn)return;const u=t.landedOn,v=new b().subVectors(t.position,u.position).normalize(),y=gt(u,p,h);t.velocity.copy(y).add(v.multiplyScalar(2));const w=u.userData.rotationSpeed||0,m=u.userData.size+.5,S=new b(0,1,0),x=new b(v.x,0,v.z);if(x.lengthSq()>.001){x.normalize();const A=new b().crossVectors(S,x).normalize(),z=Math.sqrt(v.x*v.x+v.z*v.z)*m*w;t.velocity.add(A.multiplyScalar(z))}t.isLanded=!1,t.landedOn=null,t.landedLocalDir=null};return{ship:t,controls:o,hud:n,viewMode:a,setShipMesh:c,matchVelocityWithNearest:s,launch:l,updateShip:(p,h,u)=>{var R;if(Jt=u,t.isLanded&&t.landedOn){const C=t.landedOn,D=C.userData.mesh,G=D?D.rotation.y:0,L=new nt().setFromAxisAngle(new b(0,1,0),G),E=t.landedLocalDir.clone().applyQuaternion(L);t.position.copy(C.position).add(E.multiplyScalar(C.userData.size+.5));const N=L.clone().multiply(t.landedLocalQuaternion);if(t.rotation.setFromQuaternion(N),n.speed="0",n.altitude="0",o.forward||o.backward||o.left||o.right){const O=7*(o.boost?3:1)*p,W=(o.forward?1:0)-(o.backward?1:0),B=(o.right?1:0)-(o.left?1:0),I=new b(0,0,-1).applyQuaternion(t.landedLocalQuaternion),T=new b(1,0,0).applyQuaternion(t.landedLocalQuaternion),q=new b().addScaledVector(I,W).addScaledVector(T,B).normalize();if(q.lengthSq()>.001){const X=t.landedLocalDir.clone().normalize(),Y=new b().crossVectors(X,q).normalize(),Z=O/(C.userData.size+.5),ot=new nt().setFromAxisAngle(Y,Z);t.landedLocalDir.applyQuaternion(ot),t.landedLocalQuaternion.premultiply(ot)}}o.up&&l(h,u),r&&(r.position.copy(t.position),r.rotation.copy(t.rotation),ce(r,o));return}const v=new nt().setFromEuler(t.rotation),y=new b(0,0,-1).applyQuaternion(v),w=new b(1,0,0).applyQuaternion(v),m=new b(0,1,0).applyQuaternion(v),S=o.boost?2.5:1;o.forward&&t.velocity.add(y.clone().multiplyScalar(t.thrust*S*p)),o.backward&&t.velocity.add(y.clone().multiplyScalar(-t.thrust*.5*p)),o.left&&t.velocity.add(w.clone().multiplyScalar(-t.thrust*.5*p)),o.right&&t.velocity.add(w.clone().multiplyScalar(t.thrust*.5*p)),o.up&&t.velocity.add(m.clone().multiplyScalar(t.thrust*.5*p)),o.down&&t.velocity.add(m.clone().multiplyScalar(-t.thrust*.5*p));const x=No(t.position,h);t.velocity.add(x.multiplyScalar(p)),i(p,h,u),t.velocity.length()>t.maxSpeed&&t.velocity.normalize().multiplyScalar(t.maxSpeed),t.position.add(t.velocity.clone().multiplyScalar(p)),r&&(r.position.copy(t.position),r.rotation.copy(t.rotation),ce(r,o));const P=Zt(t.position,h);let z=t.velocity.length();if(P.body){const C=gt(P.body,h,Jt);z=new b().subVectors(t.velocity,C).length()}if(n.speed=z.toFixed(0),n.nearestBody=((R=P.body)==null?void 0:R.userData.name)||null,n.nearestDistance=P.distance.toFixed(0),n.altitude=P.distance.toFixed(0),n.isThrusting=o.forward||o.backward||o.left||o.right||o.up||o.down,n.isMatchingVelocity=t.isMatchingVelocity,P.distance<.5&&P.body){t.isLanded=!0,t.landedOn=P.body,t.isMatchingVelocity=!1,t.matchingTarget=null,t.initialVelocityDiff=0;const C=P.body.userData.mesh?P.body.userData.mesh.rotation.y:0;t.landedLocalDir=new b().subVectors(t.position,P.body.position).normalize(),t.landedLocalDir.applyAxisAngle(new b(0,1,0),-C);const D=new nt().setFromEuler(t.rotation),G=new nt().setFromAxisAngle(new b(0,1,0),C);t.landedLocalQuaternion.copy(G.invert().multiply(D));const L=gt(P.body,h,Jt);t.velocity.copy(L)}},updateCamera:(p,h)=>{const u=new nt;u.setFromEuler(t.rotation),new b(0,0,-1).applyQuaternion(u);const v=new b(0,1,0).applyQuaternion(u),y=new b(0,0,1).applyQuaternion(u);if(a.value==="first")p.position.copy(t.position),p.quaternion.copy(u),r&&(r.visible=!1);else if(a.value==="third"){const w=y.clone().multiplyScalar(40).add(v.clone().multiplyScalar(15));p.position.copy(t.position).add(w),p.lookAt(t.position),r&&(r.visible=!0)}else if(a.value==="orbit"){const w=Zt(t.position,h);if(w.body){const m=w.body.position.clone(),S=new b().subVectors(t.position,m).normalize();p.position.copy(m).add(S.multiplyScalar(w.body.userData.size*4+10)),p.lookAt(t.position),r&&(r.visible=!0)}}},handleMouseMove:(p,h)=>{if(!h)return;const u=.002;if(t.isLanded&&t.landedOn){const m=t.landedLocalDir.clone().normalize(),S=new b(0,0,-1).applyQuaternion(t.landedLocalQuaternion);let x=new b().crossVectors(S,m).normalize();if(x.lengthSq()<.001){const R=new b(0,1,0).applyQuaternion(t.landedLocalQuaternion);x=new b().crossVectors(R,m).normalize()}const A=new nt().setFromAxisAngle(m,-p.movementX*u),P=new nt().setFromAxisAngle(x,-p.movementY*u);t.landedLocalQuaternion.premultiply(A),t.landedLocalQuaternion.multiply(P);const z=new b(0,0,-1).applyQuaternion(t.landedLocalQuaternion);if(Math.abs(z.dot(m))<.999){const R=new b().crossVectors(z,m).normalize(),C=new b().crossVectors(m,R).normalize(),D=new Te().makeBasis(R,m,C.negate());t.landedLocalQuaternion.setFromRotationMatrix(D)}return}const v=new nt().setFromEuler(t.rotation),y=new nt().setFromAxisAngle(new b(0,1,0),-p.movementX*u),w=new nt().setFromAxisAngle(new b(1,0,0),-p.movementY*u);v.multiply(y),v.multiply(w),t.rotation.setFromQuaternion(v)},cycleViewMode:()=>{const p=["first","third","orbit"],h=p.indexOf(a.value);a.value=p[(h+1)%p.length]}}},To=()=>{const e=Mt(!1),t=Mt(""),o=Nt({leftX:0,leftY:0,rightX:0,rightY:0}),n=Nt({a:!1,b:!1,x:!1,y:!1,lb:!1,rb:!1,lt:0,rt:0,back:!1,start:!1,leftStick:!1,rightStick:!1,up:!1,down:!1,left:!1,right:!1}),a=.15,r=h=>Math.abs(h)<a?0:(h>0?1:-1)*(Math.abs(h)-a)/(1-a),c=()=>{var v,y,w,m,S,x,A,P,z,R,C,D,G,L,E,N;const h=navigator.getGamepads();let u=null;for(const O of h)if(O&&O.connected){u=O;break}if(!u){e.value=!1,t.value="";return}e.value=!0,t.value=u.id,o.leftX=r(u.axes[0]||0),o.leftY=r(u.axes[1]||0),o.rightX=r(u.axes[2]||0),o.rightY=r(u.axes[3]||0),n.a=((v=u.buttons[0])==null?void 0:v.pressed)||!1,n.b=((y=u.buttons[1])==null?void 0:y.pressed)||!1,n.x=((w=u.buttons[2])==null?void 0:w.pressed)||!1,n.y=((m=u.buttons[3])==null?void 0:m.pressed)||!1,n.lb=((S=u.buttons[4])==null?void 0:S.pressed)||!1,n.rb=((x=u.buttons[5])==null?void 0:x.pressed)||!1,n.lt=((A=u.buttons[6])==null?void 0:A.value)||0,n.rt=((P=u.buttons[7])==null?void 0:P.value)||0,n.back=((z=u.buttons[8])==null?void 0:z.pressed)||!1,n.start=((R=u.buttons[9])==null?void 0:R.pressed)||!1,n.leftStick=((C=u.buttons[10])==null?void 0:C.pressed)||!1,n.rightStick=((D=u.buttons[11])==null?void 0:D.pressed)||!1,n.up=((G=u.buttons[12])==null?void 0:G.pressed)||!1,n.down=((L=u.buttons[13])==null?void 0:L.pressed)||!1,n.left=((E=u.buttons[14])==null?void 0:E.pressed)||!1,n.right=((N=u.buttons[15])==null?void 0:N.pressed)||!1},s=h=>{h.forward=o.leftY<-.1,h.backward=o.leftY>.1,h.left=o.leftX<-.1,h.right=o.leftX>.1,h.up=n.rt>.1||n.a,h.down=n.lt>.1,h.rollLeft=n.lb,h.rollRight=n.rb,h.boost=n.leftStick},i=()=>({yaw:o.rightX*.12,pitch:o.rightY*.12});let l=null;const d=()=>{c(),l=requestAnimationFrame(d)},g=h=>{console.log("Gamepad connected:",h.gamepad.id),e.value=!0,t.value=h.gamepad.id},M=h=>{console.log("Gamepad disconnected:",h.gamepad.id),e.value=!1,t.value=""};return{gamepadConnected:e,gamepadName:t,axes:o,buttons:n,mapToControls:s,getRotationInput:i,startPolling:()=>{typeof window>"u"||(window.addEventListener("gamepadconnected",g),window.addEventListener("gamepaddisconnected",M),d())},stopPolling:()=>{l&&(cancelAnimationFrame(l),l=null),typeof window<"u"&&(window.removeEventListener("gamepadconnected",g),window.removeEventListener("gamepaddisconnected",M))}}},Eo={class:"backdrop-blur-sm bg-black/50 rounded-xl border border-cyan-500/30 p-4 min-w-[220px]"},Fo={class:"text-xs text-cyan-300/60 uppercase tracking-wider mb-3 flex items-center gap-2"},Oo={key:0,class:"px-1.5 py-0.5 bg-orange-500/30 text-orange-300 rounded text-[10px] animate-pulse"},Bo={key:1,class:"px-1.5 py-0.5 bg-cyan-500/30 text-cyan-300 rounded text-[10px] animate-pulse"},Wo={class:"space-y-2 text-sm"},Qo={class:"flex justify-between"},jo={class:"text-cyan-100 font-mono"},qo={class:"flex justify-between"},Uo={class:"text-cyan-100 font-mono"},Ho={key:0,class:"flex justify-between items-center"},Xo={class:"text-amber-200"},Ko={key:1,class:"flex justify-between"},Yo={class:"text-amber-200"},$o={key:2,class:"mt-2 pt-2 border-t border-cyan-500/20"},Zo={class:"flex justify-between items-center"},Jo={class:"text-cyan-300 font-mono text-xs"},tn={class:"mt-1.5 h-1.5 bg-cyan-900/50 rounded-full overflow-hidden"},en={class:"mt-3 pt-3 border-t border-cyan-500/20"},on={class:"flex justify-between text-xs"},nn={class:"text-cyan-100/80 font-mono text-[10px]"},sn={__name:"SpaceshipHUD",props:{hud:{type:Object,required:!0},ship:{type:Object,required:!0}},setup(e){return(t,o)=>{var n,a;return at(),it("div",Eo,[f("div",Fo,[o[0]||(o[0]=j(" 飞船状态 ",-1)),e.hud.isThrusting?(at(),it("span",Oo," 推进中 ")):ut("",!0),e.hud.isMatchingVelocity?(at(),it("span",Bo," 速度同步 ")):ut("",!0)]),f("div",Wo,[f("div",Qo,[o[1]||(o[1]=f("span",{class:"text-cyan-200/60"},"速度",-1)),f("span",jo,dt(e.hud.speed)+" m/s",1)]),f("div",qo,[o[2]||(o[2]=f("span",{class:"text-cyan-200/60"},"距离",-1)),f("span",Uo,dt(e.hud.altitude)+" m",1)]),e.ship.isLanded?(at(),it("div",Ho,[o[3]||(o[3]=f("span",{class:"text-green-300 flex items-center gap-1.5"}," 已降落 ",-1)),f("span",Xo,dt((n=e.ship.landedOn)==null?void 0:n.userData.name),1)])):e.hud.nearestBody?(at(),it("div",Ko,[o[4]||(o[4]=f("span",{class:"text-cyan-200/60"},"最近天体",-1)),f("span",Yo,dt(e.hud.nearestBody),1)])):ut("",!0),e.hud.isMatchingVelocity&&!e.ship.isLanded?(at(),it("div",$o,[f("div",Zo,[o[5]||(o[5]=f("span",{class:"text-cyan-200/60"},"同步中",-1)),f("span",Jo,dt((a=e.ship.matchingTarget)==null?void 0:a.userData.name),1)]),f("div",tn,[f("div",{class:"h-full bg-gradient-to-r from-cyan-500 to-cyan-300 transition-all duration-150",style:Qe({width:`${e.ship.initialVelocityDiff>.5?Math.max(0,100-Math.sqrt(Math.pow(e.ship.velocity.x-e.ship.targetVelocity.x,2)+Math.pow(e.ship.velocity.z-e.ship.targetVelocity.z,2))/e.ship.initialVelocityDiff*100):100}%`})},null,4)])])):ut("",!0)]),f("div",en,[f("div",on,[o[6]||(o[6]=f("span",{class:"text-cyan-200/60"},"坐标 (m)",-1)),f("span",nn,dt(Math.round(e.ship.position.x))+", "+dt(Math.round(e.ship.position.y))+", "+dt(Math.round(e.ship.position.z)),1)])])])}}},an={key:0,class:"space-y-2"},rn={key:0,class:"backdrop-blur-sm bg-black/50 rounded-xl border border-cyan-500/30 p-4 text-xs"},cn={key:1,class:"backdrop-blur-sm bg-black/50 rounded-xl border border-green-500/30 p-4 text-xs"},ln={__name:"ControlsPanel",props:{visible:{type:Boolean,default:!0},gamepadConnected:{type:Boolean,default:!1}},setup(e){return(t,o)=>(at(),je(qe,{"enter-active-class":"transition-all duration-300 ease-out","leave-active-class":"transition-all duration-200 ease-in","enter-from-class":"opacity-0 translate-x-4","leave-to-class":"opacity-0 translate-x-4"},{default:fe(()=>[e.visible?(at(),it("div",an,[e.gamepadConnected?ut("",!0):(at(),it("div",rn,[...o[0]||(o[0]=[f("div",{class:"text-cyan-300/60 uppercase tracking-wider mb-3"},"键盘控制 (H 隐藏)",-1),f("div",{class:"grid grid-cols-2 gap-x-6 gap-y-1 text-cyan-200/80"},[f("div",null,[f("span",{class:"text-cyan-400"},"鼠标"),j(" 视角控制")]),f("div",null,[f("span",{class:"text-cyan-400"},"点击"),j(" 锁定鼠标")]),f("div",null,[f("span",{class:"text-cyan-400"},"W/S"),j(" 前进/后退")]),f("div",null,[f("span",{class:"text-cyan-400"},"A/D"),j(" 左移/右移")]),f("div",null,[f("span",{class:"text-cyan-400"},"Space"),j(" 上升")]),f("div",null,[f("span",{class:"text-cyan-400"},"Ctrl"),j(" 下降")]),f("div",null,[f("span",{class:"text-cyan-400"},"Q/E"),j(" 左转/右转")]),f("div",null,[f("span",{class:"text-cyan-400"},"↑/↓"),j(" 俯仰")]),f("div",null,[f("span",{class:"text-cyan-400"},"Shift"),j(" 加速")]),f("div",null,[f("span",{class:"text-cyan-400"},"X"),j(" 速度同步")]),f("div",null,[f("span",{class:"text-cyan-400"},"F"),j(" 起飞")]),f("div",null,[f("span",{class:"text-cyan-400"},"V"),j(" 切换视角")])],-1)])])),e.gamepadConnected?(at(),it("div",cn,[...o[1]||(o[1]=[f("div",{class:"text-green-300/60 uppercase tracking-wider mb-3"},"手柄控制",-1),f("div",{class:"grid grid-cols-2 gap-x-6 gap-y-1 text-green-200/80"},[f("div",null,[f("span",{class:"text-green-400"},"左摇杆"),j(" 移动")]),f("div",null,[f("span",{class:"text-green-400"},"右摇杆"),j(" 视角")]),f("div",null,[f("span",{class:"text-green-400"},"RT"),j(" 上升")]),f("div",null,[f("span",{class:"text-green-400"},"LT"),j(" 下降")]),f("div",null,[f("span",{class:"text-green-400"},"LB/RB"),j(" 翻滚")]),f("div",null,[f("span",{class:"text-green-400"},"左摇杆按下"),j(" 加速")]),f("div",null,[f("span",{class:"text-green-400"},"A"),j(" 起飞/上升")]),f("div",null,[f("span",{class:"text-green-400"},"X"),j(" 速度同步")]),f("div",null,[f("span",{class:"text-green-400"},"B"),j(" 切换视角")]),f("div",null,[f("span",{class:"text-green-400"},"Start"),j(" 隐藏说明")])],-1)])])):ut("",!0)])):ut("",!0)]),_:1}))}},dn={class:"fixed inset-0 w-full h-full overflow-hidden bg-[#020206] outline-none",tabindex:"0"},un={key:0,class:"absolute inset-0 flex items-center justify-center z-50 bg-[#020206]"},mn={class:"absolute bottom-4 left-4 md:bottom-6 md:left-6 z-10 space-y-2"},pn={class:"absolute bottom-4 right-4 md:bottom-6 md:right-6 z-10"},hn={class:"absolute bottom-4 left-1/2 -translate-x-1/2 z-10 flex gap-2 items-center"},fn={key:0,class:"px-3 py-1.5 rounded-lg bg-black/50 backdrop-blur-sm border border-green-500/30 text-green-300/80 text-xs flex items-center gap-1.5"},vn={__name:"SpaceshipSimulator",setup(e){const t=Mt(null),o=Mt(!0),n=Mt(!0);let a,r,c,s=null,i=0,l=[],d=Math.random()*Math.PI*2,g=0,M=0,k=null,p=new b(0,0,0),h=0,u=!1,v=null;const y=new b(8943,50,50),{ship:w,controls:m,hud:S,viewMode:x,setShipMesh:A,matchVelocityWithNearest:P,launch:z,updateShip:R,updateCamera:C,handleMouseMove:D,cycleViewMode:G}=Io(y),{gamepadConnected:L,buttons:E,mapToControls:N,getRotationInput:O,startPolling:W,stopPolling:B}=To();let I={x:!1,b:!1,start:!1};const T=()=>{a=new Ee,r=new Fe(45,t.value.clientWidth/t.value.clientHeight,.5,15e4),c=new Oe({antialias:!0,alpha:!0}),c.setSize(t.value.clientWidth,t.value.clientHeight),c.setPixelRatio(Math.min(window.devicePixelRatio,2)),c.toneMapping=Be,c.toneMappingExposure=1,t.value.appendChild(c.domElement),a.add(Vo());const _=new We(3359829,.6);a.add(_);let K=!1;$e.forEach(Q=>{const{group:ct,sunCoronaGroup:mt}=Go(Q);a.add(ct),l.push(ct),mt&&(k=mt),Q.orbitRadius>0&&!Q.isTwin&&!Q.isComet&&!Q.isQuantum&&a.add(re(Q.orbitRadius)),Q.isTwin&&!K&&(a.add(re(Q.orbitRadius)),K=!0),Q.isComet&&Q.orbitA&&Q.orbitB&&a.add(Lo(Q.orbitA,Q.orbitB))}),v=_o(w.position),A(v),a.add(v);const rt=le(.016,l,d,g,M);d=rt.twinSystemAngle,M=rt.quantumAngle;const H=l.find(Q=>Q.userData.name==="木炉星");if(H){const Q=H.position,ct=H.userData.size;w.position.set(Q.x,Q.y+ct+.5,Q.z),v.position.copy(w.position),w.isLanded=!0,w.landedOn=H;const mt=H.userData.mesh?H.userData.mesh.rotation.y:0;w.landedLocalDir=new b(0,1,0);const bt=new nt().setFromEuler(new he(0,0,0)),kt=new nt().setFromAxisAngle(new b(0,1,0),mt);w.landedLocalQuaternion.copy(kt.invert().multiply(bt)),w.rotation.setFromQuaternion(bt);const Pt=gt(H,l,d);w.velocity.copy(Pt)}o.value=!1},q=_=>{s=requestAnimationFrame(q);const K=Math.min((_-i)/1e3,.1);if(i=_,h+=K,L.value){N(m);const H=O();if(Math.abs(H.yaw)>.01||Math.abs(H.pitch)>.01){const ct={movementX:H.yaw/.002,movementY:H.pitch/.002};D(ct,!0)}E.b&&!I.b&&G(),E.x&&!I.x&&P(l,d),E.start&&!I.start&&(n.value=!n.value),I.x=E.x,I.b=E.b,I.start=E.start}const rt=le(K,l,d,g,M);d=rt.twinSystemAngle,M=rt.quantumAngle,R(K,l,d),C(r,l),k&&Po(k,h),l.forEach(H=>{H.userData.atmosphere&&so(H.userData.atmosphere,p),H.userData.updateModel&&H.userData.updateModel(p)}),c.render(a,r)},X=_=>{switch(_.code){case"KeyW":m.forward=!0;break;case"KeyS":m.backward=!0;break;case"KeyA":m.left=!0;break;case"KeyD":m.right=!0;break;case"Space":m.up=!0;break;case"ControlLeft":case"ControlRight":m.down=!0;break;case"KeyQ":m.rollLeft=!0;break;case"KeyE":m.rollRight=!0;break;case"ArrowUp":m.pitchUp=!0;break;case"ArrowDown":m.pitchDown=!0;break;case"ShiftLeft":case"ShiftRight":m.boost=!0;break;case"KeyX":P(l,d);break;case"KeyF":z(l,d);break;case"KeyH":n.value=!n.value;break;case"KeyV":G();break}},Y=_=>{switch(_.code){case"KeyW":m.forward=!1;break;case"KeyS":m.backward=!1;break;case"KeyA":m.left=!1;break;case"KeyD":m.right=!1;break;case"Space":m.up=!1;break;case"ControlLeft":case"ControlRight":m.down=!1;break;case"KeyQ":m.rollLeft=!1;break;case"KeyE":m.rollRight=!1;break;case"ArrowUp":m.pitchUp=!1;break;case"ArrowDown":m.pitchDown=!1;break;case"ShiftLeft":case"ShiftRight":m.boost=!1;break}},Z=()=>{t.value&&(r.aspect=t.value.clientWidth/t.value.clientHeight,r.updateProjectionMatrix(),c.setSize(t.value.clientWidth,t.value.clientHeight))},ot=_=>{D(_,u)},J=()=>{u=document.pointerLockElement===t.value},tt=()=>{!u&&t.value&&t.value.requestPointerLock()},et=()=>{if(document.visibilityState==="visible"){let _;do _=Math.floor(Math.random()*te.length);while(_===g&&te.length>1);g=_,M=Math.random()*Math.PI*2}};return He(()=>{typeof window<"u"&&t.value&&(T(),i=performance.now(),q(i),window.addEventListener("resize",Z),window.addEventListener("keydown",X),window.addEventListener("keyup",Y),document.addEventListener("visibilitychange",et),document.addEventListener("pointerlockchange",J),document.addEventListener("mousemove",ot),t.value.addEventListener("click",tt),W(),t.value.focus())}),Xe(()=>{s&&cancelAnimationFrame(s),B(),window.removeEventListener("resize",Z),window.removeEventListener("keydown",X),window.removeEventListener("keyup",Y),document.removeEventListener("visibilitychange",et),document.removeEventListener("pointerlockchange",J),document.removeEventListener("mousemove",ot),t.value&&t.value.removeEventListener("click",tt),c&&c.dispose()}),(_,K)=>(at(),it("div",dn,[o.value?(at(),it("div",un,[...K[1]||(K[1]=[f("div",{class:"text-center"},[f("div",{class:"w-16 h-16 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin mx-auto mb-4"}),f("div",{class:"text-amber-200/80 text-lg tracking-widest font-light"},"初始化飞船系统...")],-1)])])):ut("",!0),f("div",{ref_key:"containerRef",ref:t,class:"w-full h-full"},null,512),K[3]||(K[3]=ie('<a href="/workshop/" class="absolute top-4 left-4 md:top-6 md:left-6 z-10 flex items-center gap-2 px-3 py-2 rounded-lg bg-black/50 backdrop-blur-sm border border-amber-500/30 text-amber-200/80 hover:text-amber-100 hover:bg-black/70 hover:border-amber-500/50 transition-all duration-300 group" data-v-8f16640b><svg class="w-5 h-5 transform group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-8f16640b><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" data-v-8f16640b></path></svg><span class="text-sm tracking-wide" data-v-8f16640b>返回</span></a><div class="absolute top-4 right-4 md:top-6 md:right-6 z-10 text-right" data-v-8f16640b><div class="text-xl md:text-2xl font-bold text-amber-200 tracking-wider drop-shadow-[0_0_20px_rgba(251,191,36,0.3)]" data-v-8f16640b> OUTER WILDS </div><div class="text-xs md:text-sm text-amber-200/60 mt-1 tracking-wide" data-v-8f16640b> SPACECRAFT SIMULATOR </div></div>',2)),f("div",mn,[Bt(sn,{hud:pt(S),ship:pt(w)},null,8,["hud","ship"])]),f("div",pn,[Bt(ln,{visible:n.value,"gamepad-connected":pt(L)},null,8,["visible","gamepad-connected"])]),K[4]||(K[4]=ie('<div class="absolute inset-0 pointer-events-none z-5" data-v-8f16640b><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" data-v-8f16640b><div class="w-6 h-6 border border-cyan-400/40 rounded-full" data-v-8f16640b></div><div class="absolute top-1/2 left-0 w-2 h-px bg-cyan-400/40 -translate-x-full -translate-y-1/2" data-v-8f16640b></div><div class="absolute top-1/2 right-0 w-2 h-px bg-cyan-400/40 translate-x-full -translate-y-1/2" data-v-8f16640b></div><div class="absolute left-1/2 top-0 w-px h-2 bg-cyan-400/40 -translate-y-full -translate-x-1/2" data-v-8f16640b></div><div class="absolute left-1/2 bottom-0 w-px h-2 bg-cyan-400/40 translate-y-full -translate-x-1/2" data-v-8f16640b></div></div></div>',1)),f("div",hn,[pt(L)?(at(),it("div",fn,[...K[2]||(K[2]=[f("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor"},[f("path",{d:"M7 6h10a5 5 0 0 1 5 5v2a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5v-2a5 5 0 0 1 5-5zm1 4a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"})],-1),j(" 手柄已连接 ",-1)])])):ut("",!0),f("button",{onClick:K[0]||(K[0]=(...rt)=>pt(G)&&pt(G)(...rt)),class:"px-3 py-1.5 rounded-lg bg-black/50 backdrop-blur-sm border border-cyan-500/30 text-cyan-200/80 text-xs hover:bg-cyan-900/30 hover:border-cyan-400/50 transition-all"}," 视角 (V): "+dt(pt(x)==="first"?"第一人称":pt(x)==="third"?"第三人称":"轨道"),1)])]))}},wn=Ue(vn,[["__scopeId","data-v-8f16640b"]]),Mn=JSON.parse('{"title":"星际拓荒","description":"","frontmatter":{"layout":"page","navbar":false,"title":"星际拓荒","music":"https://raw.githubusercontent.com/v-laughing/assets/master/music/Outer-Wilds.mp3"},"headers":[],"relativePath":"workshop/spaceship-simulator.md","filePath":"workshop/spaceship-simulator.md"}'),gn={name:"workshop/spaceship-simulator.md"},Sn=Object.assign(gn,{setup(e){return(t,o)=>{const n=Ke("ClientOnly");return at(),it("div",null,[Bt(n,null,{default:fe(()=>[Bt(wn)]),_:1})])}}});export{Mn as __pageData,Sn as default};
